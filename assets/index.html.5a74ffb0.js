import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o,c,d as n,e as s,b as t,f as e,r as i}from"./app.f66cef50.js";const l={},u={href:"https://juejin.cn/post/7146976516692410376",target:"_blank",rel:"noopener noreferrer"},r=e(`<h2 id="前端工程化导图" tabindex="-1"><a class="header-anchor" href="#前端工程化导图" aria-hidden="true">#</a> 前端工程化导图</h2><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca0fcaed7ef445ae868656e9581dd348~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="前端工程化.png"></p><h2 id="构建工具" tabindex="-1"><a class="header-anchor" href="#构建工具" aria-hidden="true">#</a> 构建工具</h2><h3 id="webpack" tabindex="-1"><a class="header-anchor" href="#webpack" aria-hidden="true">#</a> Webpack</h3><p><code>Webpack</code>是前端最常用的构建工具，重要程度无需多言</p><p>之前看过很多关于 Webpack 的文章，总是感觉云里雾里，现在换一种方式，我们一起来解密它，尝试打开这个<code>盲盒</code></p><h4 id="手写一个-mini-版的-webpack" tabindex="-1"><a class="header-anchor" href="#手写一个-mini-版的-webpack" aria-hidden="true">#</a> 手写一个 mini 版的 Webpack</h4><p>别担心</p><p>我们不需要去掌握具体的实现细节，而是通过这个案例，了解 webpack 的整体打包流程，明白这个过程中做了哪些事情，最终输出了什么结果即可</p><h5 id="创建minipack-js" tabindex="-1"><a class="header-anchor" href="#创建minipack-js" aria-hidden="true">#</a> <strong>创建<code>minipack.js</code></strong></h5><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">path</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// babylon解析js语法，生产AST 语法树</span>
<span class="token comment">// ast将js代码转化为一种JSON数据结构</span>
<span class="token keyword">const</span> <span class="token constant">babylon</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;babylon&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// babel-traverse是一个对ast进行遍历的工具, 对ast进行替换</span>
<span class="token keyword">const</span> <span class="token constant">traverse</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;babel-traverse&#39;</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token comment">// 将es6 es7 等高级的语法转化为es5的语法</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> transformFromAst <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;babel-core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每一个js文件，对应一个id</span>
let <span class="token constant">ID</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// filename参数为文件路径, 读取内容并提取它的依赖关系</span>
<span class="token keyword">function</span> <span class="token function-definition function">createAsset</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">content</span> <span class="token operator">=</span> fs<span class="token operator">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取该文件对应的ast 抽象语法树</span>
  <span class="token keyword">const</span> <span class="token constant">ast</span> <span class="token operator">=</span> babylon<span class="token operator">.</span><span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    sourceType<span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;module&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// dependencies保存所依赖的模块的相对路径</span>
  <span class="token keyword">const</span> <span class="token constant">dependencies</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 通过查找import节点，找到该文件的依赖关系</span>
  <span class="token comment">// 因为项目中我们都是通过 import 引入其他文件的，找到了import节点，就找到这个文件引用了哪些文件</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    ImportDeclaration<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> node <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查找import节点</span>
      dependencies<span class="token operator">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token operator">.</span>source<span class="token operator">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 通过递增计数器，为此模块分配唯一标识符, 用于缓存已解析过的文件</span>
  <span class="token keyword">const</span> <span class="token constant">id</span> <span class="token operator">=</span> <span class="token constant">ID</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">// 该\`presets\`选项是一组规则，告诉\`babel\`如何传输我们的代码.</span>
  <span class="token comment">// 用\`babel-preset-env\`将代码转换为浏览器可以运行的东西.</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;env&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回此模块的相关信息</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">,</span> <span class="token comment">// 文件id（唯一）</span>
    filename<span class="token punctuation">,</span> <span class="token comment">// 文件路径</span>
    dependencies<span class="token punctuation">,</span> <span class="token comment">// 文件的依赖关系</span>
    code <span class="token comment">// 文件的代码</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 我们将提取它的每一个依赖文件的依赖关系，循环下去：找到对应这个项目的\`依赖图\`</span>
<span class="token keyword">function</span> <span class="token function-definition function">createGraph</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 得到入口文件的依赖关系</span>
  <span class="token keyword">const</span> <span class="token constant">mainAsset</span> <span class="token operator">=</span> <span class="token function">createAsset</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">queue</span> <span class="token operator">=</span> <span class="token punctuation">[</span>mainAsset<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> asset of queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    asset<span class="token operator">.</span>mapping <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取这个模块所在的目录</span>
    <span class="token keyword">const</span> <span class="token constant">dirname</span> <span class="token operator">=</span> path<span class="token operator">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>asset<span class="token operator">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    asset<span class="token operator">.</span>dependencies<span class="token operator">.</span><span class="token keyword">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过将相对路径与父资源目录的路径连接,将相对路径转变为绝对路径</span>
      <span class="token comment">// 每个文件的绝对路径是固定、唯一的</span>
      <span class="token keyword">const</span> <span class="token constant">absolutePath</span> <span class="token operator">=</span> path<span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 递归解析其中所引入的其他资源</span>
      <span class="token keyword">const</span> <span class="token constant">child</span> <span class="token operator">=</span> <span class="token function">createAsset</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      asset<span class="token operator">.</span>mapping<span class="token punctuation">[</span>relativePath<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token operator">.</span>id<span class="token punctuation">;</span>
      <span class="token comment">// 将\`child\`推入队列, 通过递归实现了这样它的依赖关系解析</span>
      queue<span class="token operator">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// queue这就是最终的依赖关系图谱</span>
  <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 自定义实现了require 方法，找到导出变量的引用逻辑</span>
<span class="token keyword">function</span> <span class="token function-definition function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  let modules <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;&#39;</span><span class="token punctuation">;</span>
  graph<span class="token operator">.</span><span class="token keyword">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    modules <span class="token operator">+=</span> <span class="token string backtick-quoted-string">\`\${mod.id}: [
      function (require, module, exports) { \${mod.code} },
      \${JSON.stringify(mod.mapping)},
    ],\`</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token constant">result</span> <span class="token operator">=</span> <span class="token string backtick-quoted-string">\`
    (function(modules) {
      function require(id) {
        const [fn, mapping] = modules[id];
        function localRequire(name) {
          return require(mapping[name]);
        }
        const module = { exports : {} };
        fn(localRequire, module, module.exports);
        return module.exports;
      }
      require(0);
    })({\${modules}})
  \`</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ❤️ 项目的入口文件</span>
<span class="token keyword">const</span> <span class="token constant">graph</span> <span class="token operator">=</span> <span class="token function">createGraph</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;./example/entry.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">result</span> <span class="token operator">=</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ⬅️ 创建dist目录，将打包的内容写入main.js中</span>
fs<span class="token operator">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;dist&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span>
    fs<span class="token operator">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;dist/main.js&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">(</span>err1<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err1<span class="token punctuation">)</span> console<span class="token operator">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;打包成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注</strong>：<code>mini版的Webpack</code>未涉及 loader 和 plugin 等复杂功能，只是一个非常简化的例子</p><h5 id="mini-版的-webpack-打包流程" tabindex="-1"><a class="header-anchor" href="#mini-版的-webpack-打包流程" aria-hidden="true">#</a> mini 版的 webpack 打包流程</h5><p>1）从入口文件开始解析 2）查找入口文件引入了哪些 js 文件，找到依赖关系 3）递归遍历引入的其他 js，生成最终的依赖关系图谱 4）同时将 ES6 语法转化成 ES5 5）最终生成一个可以在浏览器加载执行的 js 文件</p><h5 id="创建测试目录-example" tabindex="-1"><a class="header-anchor" href="#创建测试目录-example" aria-hidden="true">#</a> 创建测试目录 example</h5><p>在目录下创建以下 4 个文件</p><p><strong>1）创建入口文件<code>entry.js</code></strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>import message from &#39;./message.js&#39;;
// 将message的内容显示到页面中
<span class="token key attr-name">let p</span> <span class="token punctuation">=</span> <span class="token value attr-value">document.createElement(&#39;p&#39;);</span>
<span class="token key attr-name">p.innerHTML</span> <span class="token punctuation">=</span> <span class="token value attr-value">message;</span>
document.body.appendChild(p);

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）创建<code>message.js</code></strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./name.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）创建<code>name.js</code></strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">export const name</span> <span class="token punctuation">=</span> <span class="token value attr-value">&#39;Webpack&#39;;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4）创建<code>index.html</code></strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Webpack App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 引入打包后的main.js --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./dist/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5） 执行打包</strong></p><p>运行<code>node minipack.js</code>，dist 目录下生成 main.js</p><p><strong>6） 浏览器打开 index.html</strong></p><p>页面上显示<code>hello Webpack!</code></p>`,28),d={href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxy-sea%2Fblog%2Ftree%2Fdev%2Fmini-webpack",target:"_blank",rel:"noopener noreferrer"},k=e(`<h4 id="分析打包生成的文件" tabindex="-1"><a class="header-anchor" href="#分析打包生成的文件" aria-hidden="true">#</a> 分析打包生成的文件</h4><p><strong>分析<code>dist/main.js</code></strong></p><h5 id="文件内容" tabindex="-1"><a class="header-anchor" href="#文件内容" aria-hidden="true">#</a> 文件内容</h5><p>1）文件里是一个立即执行函数</p><p>2）该函数接收的参数是一个对象，该对象有 3 个属性 <code>0</code> 代表<code>entry.js</code>; <code>1</code> 代表<code>message.js</code>; <code>2</code> 代表<code>name.js</code></p><p><strong>dist/main.js 代码</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 文件里是一个立即执行函数</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>fn<span class="token punctuation">,</span> mapping<span class="token punctuation">]</span> <span class="token operator">=</span> modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">localRequire</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ⬅️ 第四步 跳转到这里 此时mapping[name] = 1，继续执行require(1)</span>
      <span class="token comment">// ⬅️ 第六步 又跳转到这里 此时mapping[name] = 2，继续执行require(2)</span>
      <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>mapping<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 创建module对象</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// ⬅️ 第二步 执行fn</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>localRequire<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ⬅️ 第一步 执行require(0)</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 立即执行函数的参数是一个对象，该对象有3个属性</span>
  <span class="token comment">// 0 代表entry.js;</span>
  <span class="token comment">// 1 代表message.js</span>
  <span class="token comment">// 2 代表name.js</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 第三步 跳转到这里 继续执行require(&#39;./message.js&#39;)</span>
      <span class="token keyword">var</span> _message <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./message.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 第九步 跳到这里 此时_message为 {default: &#39;hello Webpack!&#39;}</span>
      <span class="token keyword">var</span> _message2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>_message<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 最后一步 将_message2.default: &#39;hello Webpack!&#39;写到p标签中</span>
      p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> _message2<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">&quot;./message.js&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 第五步 跳转到这里 继续执行require(&#39;./name.js&#39;)</span>
      <span class="token keyword">var</span> _name <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./name.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 第八步 跳到这里 此时_name为{name: &#39;Webpack&#39;}, 在exports对象上设置default属性，值为&#39;hello Webpack!&#39;</span>
      exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token string">&quot;hello &quot;</span> <span class="token operator">+</span> _name<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">&quot;./name.js&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ⬅️ 第七步 跳到这里 在传入的exports对象上添加name属性，值为&#39;Webpack&#39;</span>
      <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="⬅️-分析文件的执行过程" tabindex="-1"><a class="header-anchor" href="#⬅️-分析文件的执行过程" aria-hidden="true">#</a> ⬅️ 分析文件的执行过程</h5><p>1）整体大致分为 10 步，第一步从<code>require(0)</code>开始执行，调用内置的自定义 require 函数，跳转到第二步，执行<code>fn</code>函数</p><p>2）执行第三步<code>require(&#39;./message.js&#39;)</code>，继续跳转到第四步 <code>require(mapping[&#39;./message.js&#39;])</code>, 最终转化为<code>require(1)</code></p><p>3）继续执行<code>require(1)</code>，获取<code>modules[1]</code>，也就是执行<code>message.js</code>的内容</p><p>4）第五步<code>require(&#39;./name.js&#39;)</code>，最终转化为<code>require(2)</code>，执行<code>name.js</code>的内容</p><p>5）通过递归调用，将代码中导出的属性，放到<code>exports</code>对象中，一层层导出到最外层</p><p>6）最终通过<code>_message2.default</code>获取导出的值，页面显示<code>hello Webpack!</code></p><h4 id="webpack-的打包流程" tabindex="-1"><a class="header-anchor" href="#webpack-的打包流程" aria-hidden="true">#</a> Webpack 的打包流程</h4><p><strong>总结一下 webpack 完整的打包流程</strong></p><p>1）webpack 从项目的<code>entry</code>入口文件开始递归分析，调用所有配置的 <code>loader</code>对模块进行编译</p><p>因为 webpack 默认只能识别 js 代码，所以如 css 文件、.vue 结尾的文件，必须要通过对应的 loader 解析成 js 代码后，webpack 才能识别</p><p>2）利用<code>babel(babylon)</code>将 js 代码转化为<code>ast抽象语法树</code>，然后通过<code>babel-traverse</code>对 ast 进行遍历</p><p>3）遍历的目的找到文件的<code>import引用节点</code></p><p>因为现在我们引入文件都是通过 import 的方式引入，所以找到了 import 节点，就找到了文件的依赖关系</p><p>4）同时每个模块生成一个唯一的 id，并将解析过的<code>模块缓存</code>起来，如果其他地方也引入该模块，就无需重新解析，最后根据依赖关系生成依赖图谱</p><p>5）递归遍历所有依赖图谱的模块，组装成一个个包含多个模块的 <code>Chunk(块)</code></p><p>6）最后将生成的文件输出到 <code>output</code> 的目录中</p><h4 id="热更新原理" tabindex="-1"><a class="header-anchor" href="#热更新原理" aria-hidden="true">#</a> 热更新原理</h4><p><strong>什么是 webpack 热更新？</strong></p><p>开发过程中，代码发生变动后，webpack 会重新编译，编译后浏览器替换修改的模块，局部更新，无需刷新整个页面</p><p><strong>好处</strong>：节省开发时间、提升开发体验</p><p><strong>热更新原理</strong></p><p>主要是通过<code>websocket</code>实现，建立本地服务和浏览器的双向通信。当代码变化，重新编译后，通知浏览器请求更新的模块，替换原有的模块</p><p>1） 通过<code>webpack-dev-server</code>开启<code>server服务</code>，本地 server 启动之后，再去启动 websocket 服务，建立本地服务和浏览器的双向通信</p><p>2） webpack 每次编译后，会生成一个<code>Hash值</code>，Hash 代表每一次编译的标识。本次输出的 Hash 值会编译新生成的文件标识，被作为下次热更新的标识</p><p>3）webpack<code>监听文件变化</code>（主要是通过文件的生成时间判断是否有变化），当文件变化后，重新编译</p><p>4）编译结束后，通知浏览器请求变化的资源，同时将新生成的 hash 值传给浏览器，用于下次热更新使用</p><p>5）浏览器拿到更新后的模块后，用新模块替换掉旧的模块，从而实现了局部刷新</p>`,35),v={href:"https://juejin.cn/post/6844904008432222215",target:"_blank",rel:"noopener noreferrer"},m={href:"https://link.juejin.cn/?target=http%3A%2F%2Fwebpack.wuhaolin.cn",target:"_blank",rel:"noopener noreferrer"},b={href:"https://juejin.cn/post/6844904079219490830",target:"_blank",rel:"noopener noreferrer"},g=e(`<h3 id="plugin" tabindex="-1"><a class="header-anchor" href="#plugin" aria-hidden="true">#</a> Plugin</h3><p><strong>作用：扩展 webpack 功能</strong></p><p><strong>工作原理</strong></p><p>webpack 通过内部的事件流机制保证了插件的有序性，底层是利用<code>发布订阅模式</code>，webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，在特定的时机对资源做处理</p><h4 id="手写一个-plugin-插件" tabindex="-1"><a class="header-anchor" href="#手写一个-plugin-插件" aria-hidden="true">#</a> 手写一个 Plugin 插件</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 自定义一个名为MyPlugin插件，该插件在打包完成后，在控制台输出&quot;打包已完成&quot;</span>
<span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">{</span>
  <span class="token comment">// 原型上需要定义apply 的方法</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过compiler获取webpack内部的钩子</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;My Plugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打包已完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 分为同步和异步的钩子，异步钩子必须执行对应的回调</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPlugin<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="在-vue-项目中使用自定义插件" tabindex="-1"><a class="header-anchor" href="#在-vue-项目中使用自定义插件" aria-hidden="true">#</a> 在 vue 项目中使用自定义插件</h4><p>1）在<code>vue.config.js</code>引入该插件</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>const MyPlugin = require(&#39;./MyPlugin.js&#39;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2）在<code>configureWebpack</code>的 plugins 列表中注册该插件</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">module.exports</span> <span class="token punctuation">=</span> <span class="token value attr-value">{</span>
  configureWebpack: {
    plugins: [new MyPlugin()]
  }
};

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）执行项目的打包命令 当项目打包成功后，会在控制台输出：<code>打包已完成</code></p><h4 id="plugin-的组成部分" tabindex="-1"><a class="header-anchor" href="#plugin-的组成部分" aria-hidden="true">#</a> Plugin 的组成部分</h4><p>1）Plugin 的本质是一个 <code>node 模块</code>，这个模块导出一个 JavaScript 类</p><p>2）它的原型上需要定义一个<code>apply</code> 的方法</p><p>3）通过<code>compiler</code>获取 webpack 内部的钩子，获取 webpack 打包过程中的各个阶段</p><p>钩子分为同步和异步的钩子，异步钩子必须执行对应的回调</p><p>4）通过<code>compilation</code>操作 webpack 内部实例特定数据</p><p>5）功能完成后，执行 webpack 提供的 cb 回调</p><p><strong>compiler 上暴露的一些常用的钩子简介</strong></p><table><thead><tr><th>钩子</th><th>类型</th><th>调用时机</th></tr></thead><tbody><tr><td>run</td><td>AsyncSeriesHook</td><td>在编译器开始读取记录前执行</td></tr><tr><td>compile</td><td>SyncHook</td><td>在一个新的 compilation 创建之前执行</td></tr><tr><td>compilation</td><td>SyncHook</td><td>在一次 compilation 创建后执行插件</td></tr><tr><td>make</td><td>AsyncParallelHook</td><td>完成一次编译之前执行</td></tr><tr><td>emit</td><td>AsyncSeriesHook</td><td>在生成文件到 output 目录之前执行，回调参数： compilation</td></tr><tr><td>afterEmit</td><td>AsyncSeriesHook</td><td>在生成文件到 output 目录之后执行</td></tr><tr><td>assetEmitted</td><td>AsyncSeriesHook</td><td>生成文件的时候执行，提供访问产出文件信息的入口，回调参数：file，info</td></tr><tr><td>done</td><td>AsyncSeriesHook</td><td>一次编译完成后执行，回调参数：stats</td></tr></tbody></table><h4 id="常用的-plugin-插件" tabindex="-1"><a class="header-anchor" href="#常用的-plugin-插件" aria-hidden="true">#</a> 常用的 Plugin 插件</h4><table><thead><tr><th>插件名称</th><th>作用</th></tr></thead><tbody><tr><td>html-webpack-plugin</td><td>生成 html 文件,引入公共的 js 和 css 资源</td></tr><tr><td>webpack-bundle-analyzer</td><td>对打包后的文件进行分析，生成资源分析图</td></tr><tr><td>terser-webpack-plugin</td><td>代码压缩，移除 console.log 打印等</td></tr><tr><td>HappyPack Plugin</td><td>开启多线程打包，提升打包速度</td></tr><tr><td>Dllplugin</td><td>动态链接库，将项目中依赖的三方模块抽离出来，单独打包</td></tr><tr><td>DllReferencePlugin</td><td>配合 Dllplugin，通过 manifest.json 映射到相关的依赖上去</td></tr><tr><td>clean-webpack-plugin</td><td>清理上一次项目生成的文件</td></tr><tr><td>vue-skeleton-webpack-plugin</td><td>vue 项目实现骨架屏</td></tr></tbody></table>`,23),h={href:"https://link.juejin.cn/?target=https%3A%2F%2Fchampyin.com%2F2020%2F01%2F12%2F%E6%8F%AD%E7%A7%98webpack-plugin%2F",target:"_blank",rel:"noopener noreferrer"},f=e(`<h3 id="loader" tabindex="-1"><a class="header-anchor" href="#loader" aria-hidden="true">#</a> Loader</h3><p><strong>Loader 作用</strong></p><p>webpack 只能直接处理 js 格式的资源，任何非 js 文件都必须被对应的<code>loader</code>处理转换为 js 代码</p><h4 id="手写一个-loader" tabindex="-1"><a class="header-anchor" href="#手写一个-loader" aria-hidden="true">#</a> 手写一个 loader</h4><p><strong>一个简单的<code>style-loader</code></strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>// 作用：将css内容，通过style标签插入到页面中
// source为要处理的css源文件
function loader(source) {
  <span class="token key attr-name">let style</span> <span class="token punctuation">=</span> <span class="token value attr-value">\`</span>
    <span class="token key attr-name">let style</span> <span class="token punctuation">=</span> <span class="token value attr-value">document.createElement(&#39;style&#39;);</span>
    style.setAttribute(&quot;type&quot;, &quot;text/css&quot;);
    <span class="token key attr-name">style.innerHTML</span> <span class="token punctuation">=</span> <span class="token value attr-value">\${source};</span>
    document.head.appendChild(style)\`;
  return style;
}
<span class="token key attr-name">module.exports</span> <span class="token punctuation">=</span> <span class="token value attr-value">loader;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="在-vue-项目中使用自定义-loader" tabindex="-1"><a class="header-anchor" href="#在-vue-项目中使用自定义-loader" aria-hidden="true">#</a> 在 vue 项目中使用自定义 loader</h4><p>1）在<code>vue.config.js</code>引入该 loader</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>const MyStyleLoader = require(&#39;./style-loader&#39;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2）在<code>configureWebpack</code>中添加配置</p><div class="language-css line-numbers-mode" data-ext="css"><pre class="language-css"><code><span class="token selector">module.exports =</span> <span class="token punctuation">{</span>
  <span class="token selector">configureWebpack:</span> <span class="token punctuation">{</span>
    <span class="token selector">module:</span> <span class="token punctuation">{</span>
      <span class="token selector">rules: [</span>
        <span class="token punctuation">{</span>
          // 对main.css文件使用MyStyleLoader处理
          <span class="token property">test</span><span class="token punctuation">:</span> /main.css/<span class="token punctuation">,</span>
          <span class="token property">loader</span><span class="token punctuation">:</span> MyStyleLoader
        <span class="token punctuation">}</span>
      ]
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）项目重新编译 <code>main.css</code>样式已加载到页面中</p><h4 id="loader-的组成部分" tabindex="-1"><a class="header-anchor" href="#loader-的组成部分" aria-hidden="true">#</a> loader 的组成部分</h4><p>loader 的本质是一个 <code>node</code>模块，该模块导出一个函数，函数接收<code>source(源文件)</code>，返回处理后的<code>source</code></p><h4 id="loader-执行顺序" tabindex="-1"><a class="header-anchor" href="#loader-执行顺序" aria-hidden="true">#</a> loader 执行顺序</h4><p>相同优先级的 loader 链，执行顺序为：<code>从右到左，从下到上</code></p><p>如<code>use: [&#39;loader1&#39;, &#39;loader2&#39;, &#39;loader3&#39;]</code>，执行顺序为 <code>loader3 → loader2 → loader1</code></p><h4 id="常用的-loader" tabindex="-1"><a class="header-anchor" href="#常用的-loader" aria-hidden="true">#</a> 常用的 loader</h4><table><thead><tr><th>名称</th><th>作用</th></tr></thead><tbody><tr><td>style-loader</td><td>用于将 css 编译完成的样式，挂载到页面 style 标签上</td></tr><tr><td>css-loader</td><td>用于识别 .css 文件, 须配合 style-loader 共同使用</td></tr><tr><td>sass-loader/less-loader</td><td>css 预处理器</td></tr><tr><td>postcss-loader</td><td>用于补充 css 样式各种浏览器内核前缀</td></tr><tr><td>url-loader</td><td>处理图片类型资源，可以转 base64</td></tr><tr><td>vue-loader</td><td>用于编译 .vue 文件</td></tr><tr><td>worker-loader</td><td>通过内联 loader 的方式使用 web worker 功能</td></tr><tr><td>style-resources-loader</td><td>全局引用对应的 css，避免页面再分别引入</td></tr></tbody></table>`,19),y={href:"https://link.juejin.cn/?target=https%3A%2F%2Fchampyin.com%2F2020%2F01%2F28%2F%E6%8F%AD%E7%A7%98webpack-loader%2F",target:"_blank",rel:"noopener noreferrer"},q=e(`<h3 id="webpack5-模块联邦" tabindex="-1"><a class="header-anchor" href="#webpack5-模块联邦" aria-hidden="true">#</a> Webpack5 模块联邦</h3><p>webpack5 <code>模块联邦(Module Federation)</code> 使 JavaScript 应用，得以从另一个 JavaScript 应用中动态的加载代码，实现共享依赖，用于前端的微服务化</p><p>比如<code>项目A</code>和<code>项目B</code>，公用<code>项目C</code>组件，以往这种情况，可以将 C 组件发布到 npm 上，然后 A 和 B 再具体引入。当 C 组件发生变化后，需要重新发布到 npm 上，A 和 B 也需要重新下载安装</p><p>使用模块联邦后，可以在远程模块的 Webpack 配置中，将 C 组件模块暴露出去，项目 A 和项目 B 就可以远程进行依赖引用。当 C 组件发生变化后，A 和 B 无需重新引用</p><p>模块联邦利用 webpack5 内置的<code>ModuleFederationPlugin</code>插件，实现了项目中间相互引用的按需热插拔</p><h4 id="webpack-modulefederationplugin" tabindex="-1"><a class="header-anchor" href="#webpack-modulefederationplugin" aria-hidden="true">#</a> <strong>Webpack ModuleFederationPlugin</strong></h4><p><strong>重要参数说明</strong></p><p>1）<code>name</code> 当前应用名称，需要全局唯一</p><p>2）<code>remotes</code> 可以将其他项目的 <code>name</code> 映射到当前项目中</p><p>3）<code>exposes</code> 表示导出的模块，只有在此申明的模块才可以作为远程依赖被使用</p><p>4）<code>shared</code> 是非常重要的参数，制定了这个参数，可以让远程加载的模块对应依赖，改为使用本地项目的依赖，如 React 或 ReactDOM</p><p><strong>配置示例</strong></p><div class="language-css line-numbers-mode" data-ext="css"><pre class="language-css"><code><span class="token selector">new ModuleFederationPlugin(</span><span class="token punctuation">{</span>
     <span class="token selector">name: &quot;app_1&quot;,
     library:</span> <span class="token punctuation">{</span> <span class="token property">type</span><span class="token punctuation">:</span> <span class="token string">&quot;var&quot;</span><span class="token punctuation">,</span> <span class="token property">name</span><span class="token punctuation">:</span> <span class="token string">&quot;app_1&quot;</span> <span class="token punctuation">}</span><span class="token selector">,
     filename: &quot;remoteEntry.js&quot;,
     remotes:</span> <span class="token punctuation">{</span>
        <span class="token property">app_02</span><span class="token punctuation">:</span> <span class="token string">&#39;app_02&#39;</span><span class="token punctuation">,</span>
        <span class="token property">app_03</span><span class="token punctuation">:</span> <span class="token string">&#39;app_03&#39;</span><span class="token punctuation">,</span>
     <span class="token punctuation">}</span><span class="token selector">,
     exposes:</span> <span class="token punctuation">{</span>
        <span class="token property">antd</span><span class="token punctuation">:</span> <span class="token string">&#39;./src/antd&#39;</span><span class="token punctuation">,</span>
        <span class="token property">button</span><span class="token punctuation">:</span> <span class="token string">&#39;./src/button&#39;</span><span class="token punctuation">,</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token property">shared</span><span class="token punctuation">:</span> [<span class="token string">&#39;react&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;react-dom&#39;</span>]<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13),w={href:"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F115403616",target:"_blank",rel:"noopener noreferrer"},j={href:"https://juejin.cn/post/6844904187147321352",target:"_blank",rel:"noopener noreferrer"},x={href:"https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fsendudu%2Farticle%2Fdetails%2F110232830",target:"_blank",rel:"noopener noreferrer"},_=e(`<h3 id="vite" tabindex="-1"><a class="header-anchor" href="#vite" aria-hidden="true">#</a> Vite</h3><p>Vite 被誉为<code>下一代的构建工具</code></p><p>上手了几个项目后，果然名不虚传，热更新速度真的是<code>快的飞起！</code></p><h4 id="vite-原理" tabindex="-1"><a class="header-anchor" href="#vite-原理" aria-hidden="true">#</a> Vite 原理</h4><p>1）Vite 利用浏览器支持原生的<code>es module</code>模块，开发时跳过打包的过程，提升编译效率</p><p>2）当通过 import 加载资源时，浏览器会发出 HTTP 请求对应的文件，<code>Vite拦截到该请求</code>，返回对应的模块文件</p><p><strong>es module 简单示例</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>import { a } from &#39;./a.js&#39;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>1）当声明一个 script 标签类型为 <code>module</code> 时，浏览器将对其内部的 import 引用发起 HTTP 请求，获取模块内容</p><p>2）浏览器将发起一个对 <code>HOST/a.js</code> 的 HTTP 请求，获取到内容之后再执行</p><p><strong>Vite 的限制</strong></p><p>Vite 主要对应的场景是开发模式（生产模式是用 <code>rollup 打包</code>）</p><h4 id="vite-热更新速度" tabindex="-1"><a class="header-anchor" href="#vite-热更新速度" aria-hidden="true">#</a> Vite 热更新速度</h4><p><strong>Vite 热更新的速度不会随着模块增多而变慢</strong></p><p>1）Webpack 的热更新原理：一旦某个依赖（比如上面的 a.js）改变，就将这个依赖所处的 整个<code>module</code> 更新，并将新的 module 发送给浏览器重新执行</p><p>试想如果依赖越来越多，就算只修改一个文件，热更新的速度会越来越慢</p><p>2）Vite 的热更新原理：如果 a.js 发生了改变，只会重新编译这个文件 a，而其余文件都无需重新编译</p><p>所以理论上 Vite 热更新的速度不会随着文件增加而变慢</p><h4 id="手写-vite" tabindex="-1"><a class="header-anchor" href="#手写-vite" aria-hidden="true">#</a> 手写 vite</h4>`,19),F={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1at4y1a7zi%3Ffrom%3Dsearch%26seid%3D13340994191382185418%26spm_id_from%3D333.337.0.0",target:"_blank",rel:"noopener noreferrer"},S=e("<p><strong>vite 的实现流程</strong></p><p>1）通过<code>koa</code>开启一个服务，获取请求的静态文件内容</p><p>2）通过<code>es-module-lexer</code> 解析 <code>ast</code> 拿到 import 的内容</p><p>3）判断 import 导入模块是否为<code>三方模块</code>，是的话，返回<code>node_module</code>下的模块， 如 <code>import vue</code> 返回 <code>import &#39;./@modules/vue&#39;</code></p><p>4）如果是<code>.vue文件</code>，vite 拦截对应的请求，读取.vue 文件内容进行编译，通过<code>compileTemplate</code> 编译模板，将<code>template转化为render函数</code></p><p>5）通过 babel parse 对 js 进行编译，最终返回编译后的 js 文件</p>",6),P={href:"https://juejin.cn/post/7021306258057592862",target:"_blank",rel:"noopener noreferrer"},T={href:"https://juejin.cn/post/6844904146915573773",target:"_blank",rel:"noopener noreferrer"},A=e(`<h3 id="babel" tabindex="-1"><a class="header-anchor" href="#babel" aria-hidden="true">#</a> Babel</h3><h4 id="ast-抽象语法树" tabindex="-1"><a class="header-anchor" href="#ast-抽象语法树" aria-hidden="true">#</a> AST 抽象语法树</h4><p>这里先聊一下<code>AST抽象语法树</code>，因为<code>AST</code>是<code>babel</code>的核心</p><p><strong>什么是 AST ？</strong></p><p><code>AST</code>是源代码的抽象语法结构的树状表现形式</p><p><strong>在 js 世界中，可以认为<code>抽象语法树(AST)是最底层</code></strong></p><p><strong>一个简单的 AST 示例</strong></p><p><code>let a = 1</code>，转化成 AST 的结果</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Program&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclaration&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
      <span class="token property">&quot;declarations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclarator&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
          <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;init&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;let&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sourceType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9),C={href:"https://link.juejin.cn/?target=https%3A%2F%2Fastexplorer.net%2F%23%2F",target:"_blank",rel:"noopener noreferrer"},L={href:"https://link.juejin.cn/?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000016231512",target:"_blank",rel:"noopener noreferrer"},D=e(`<h4 id="babel-基本原理与作用" tabindex="-1"><a class="header-anchor" href="#babel-基本原理与作用" aria-hidden="true">#</a> Babel 基本原理与作用</h4><p><code>Babel</code> 是一个 <code>JS 编译器</code>，把我们的代码转成浏览器可以运行的代码</p><p><strong>作用</strong></p><p>babel 主要用于将新版本的代码转换为向后兼容的 js 语法(<code>Polyfill</code> 方式)，以便能够运行在各版本的浏览器或其他环境中</p><p><strong>基本原理</strong></p><p>核心就是 <code>AST (抽象语法树)</code></p><p>首先将源码转成抽象语法树，然后对语法树进行处理生成新的语法树，最后将新语法树生成新的 JS 代码</p><p><strong>Babel 的流程</strong></p><p><strong>3 个阶段： parsing (解析)、transforming (转换)、generating (生成)</strong></p><p>1）通过<code>babylon</code>将 js 转化成 ast (抽象语法树)</p><p>2）通过<code>babel-traverse</code>是一个对 ast 进行遍历，使用 babel 插件转化成新的 ast</p><p>3）通过<code>babel-generator</code>将 ast 生成新的 js 代码</p><h4 id="配置和使用" tabindex="-1"><a class="header-anchor" href="#配置和使用" aria-hidden="true">#</a> 配置和使用</h4><p><strong>1）单个软件包在 <code>.babelrc</code> 中配置</strong></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>.babelrc <span class="token punctuation">{</span>
  <span class="token comment">// 预设: Babel 官方做了一些预设的插件集，称之为 Preset，我们只需要使用对应的 Preset 就可以了</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token comment">// babel和webpack类似，主要是通过plugin插件进行代码转化的，如果不配置插件，babel会将代码原样返回</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）vue 中，在 babel.config.js 中配置</strong></p><p>配置 babel-plugin-component 插件，按需引入 elementUI</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">module</span><span class="token punctuation">.</span><span class="token keyword">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
   presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@vue/app&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 配置babel-plugin-component插件</span>
   plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
	  <span class="token string">&quot;component&quot;</span><span class="token punctuation">,</span>
	  <span class="token punctuation">{</span>
	    libraryName<span class="token operator">:</span> <span class="token string">&quot;element-ui&quot;</span><span class="token punctuation">,</span>
	    styleLibraryName<span class="token operator">:</span> <span class="token string">&quot;theme-chalk&quot;</span>
	<span class="token punctuation">}</span>
     <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）配置<code>browserslist</code></strong></p><p><code>browserslist</code> 用来控制要兼容浏览器版本，配置的范围越具体，就可以更精确控制<code>Polyfill</code>转化后的体积大小</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;browserslist&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token comment">// 全球超过1%人使用的浏览器</span>
   <span class="token string">&quot;&gt; 1%&quot;</span><span class="token punctuation">,</span>
   <span class="token comment">//  所有浏览器兼容到最后两个版本根据CanIUse.com追踪的版本</span>
   <span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">,</span>
   <span class="token comment">// chrome 版本大于70</span>
   <span class="token string">&quot;chrome &gt;= 70&quot;</span>
   <span class="token comment">// 排除部分版本</span>
   <span class="token string">&quot;not ie &lt;= 8&quot;</span>
<span class="token punctuation">]</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="如何开发一个-babel-插件" tabindex="-1"><a class="header-anchor" href="#如何开发一个-babel-插件" aria-hidden="true">#</a> 如何开发一个 babel 插件</h4><p><strong>Babel 插件的作用</strong></p><p>Babel 插件担负着编译过程中的核心任务：<code>转换 AST</code></p><p><strong>babel 插件的基本格式</strong></p><p>1）一个函数，参数是 babel，然后就是返回一个对象，<code>key是visitor</code>，然后里面的对象是一个箭头函数</p><p>2）函数有两个参数，<code>path</code>表示路径，<code>state</code>表示状态</p><p>3）<code>CallExpression</code>就是我们要访问的节点，path 参数表示当前节点的位置，包含的主要是当前<code>节点（node）</code>内容以及<code>父节点（parent）</code>内容</p><p><strong>插件的简单格式示例</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> t <span class="token operator">=</span> babel<span class="token punctuation">.</span>type
   <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">CallExression</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">do</span> soming
     <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>一个最简单的插件: <code>将const a 转化为const b</code></strong></p><p>创建 babelPluginAtoB.js</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">module.exports</span> <span class="token punctuation">=</span> <span class="token value attr-value">function(babel) {</span>
  <span class="token key attr-name">let t</span> <span class="token punctuation">=</span> <span class="token value attr-value">babel.types;</span>
  return {
    visitor: {
      VariableDeclarator(path, state) {
        // VariableDeclarator 是要找的变量声明
        <span class="token key attr-name">if (path.node.id.name</span> <span class="token punctuation">=</span><span class="token value attr-value">= &quot;a&quot;) {</span>
         // 方式一：直接修改name
         <span class="token key attr-name">path.node.id.name</span> <span class="token punctuation">=</span> <span class="token value attr-value">&#39;b&#39;;</span>
         // 方式二：把id是a的ast换成b的ast
         <span class="token key attr-name">// path.node.id</span> <span class="token punctuation">=</span> <span class="token value attr-value">t.Identifier(&quot;b&quot;);</span>
        }
      }
    }
  };
};

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在.babelrc 中引入 babelPluginAtoB 插件</strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">const babelPluginAtoB</span> <span class="token punctuation">=</span> <span class="token value attr-value">require(&#39;./babelPluginAtoB.js&#39;);</span>
{
    &quot;plugins&quot;: [
        <span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">babelPluginAtoB</span><span class="token punctuation">]</span></span>
    ]
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>编写测试代码</strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">let a</span> <span class="token punctuation">=</span> <span class="token value attr-value">1;</span>
console.log(b);
// babel插件生效，没有报错，打印 1

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,37),E={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2016%2F01%2Fbabel.html",target:"_blank",rel:"noopener noreferrer"},M={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.babeljs.cn%2Fdocs%2F",target:"_blank",rel:"noopener noreferrer"},z={href:"https://juejin.cn/post/6844904008679686152",target:"_blank",rel:"noopener noreferrer"},I={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F44c0075fd043",target:"_blank",rel:"noopener noreferrer"},O=e('<h3 id="gulp" tabindex="-1"><a class="header-anchor" href="#gulp" aria-hidden="true">#</a> Gulp</h3><p><code>gulp</code> 是基于 <code>node 流</code> 实现的前端自动化开发的工具</p><p><strong>适用场景</strong></p><p>在前端开发工作中有很多<code>“重复工作”</code>，比如<code>批量将Scss文件编译为CSS文件</code></p><p><strong>这里主要聊一下，在开发的组件库中如何使用 gulp</strong></p><h4 id="gulp-在组件库中的运用" tabindex="-1"><a class="header-anchor" href="#gulp-在组件库中的运用" aria-hidden="true">#</a> Gulp 在组件库中的运用</h4>',6),B=n("code",null,"elementUI",-1),H={href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FElemeFE%2Felement",target:"_blank",rel:"noopener noreferrer"},N=e(`<p>打开<code>packages/theme-chalk/gulpfile.js</code></p><p><strong>该文件的作用是将 scss 文件编译为 css 文件</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 引入gulp</span>
<span class="token comment">// series创建任务列表，</span>
<span class="token comment">// src创建一个流，读取文件</span>
<span class="token comment">// dest 创建一个对象写入到文件系统的流</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// gulp-dart-sass编译scss文件</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-dart-sass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// gulp-autoprefixer 给css样式添加前缀</span>
<span class="token keyword">const</span> autoprefixer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-autoprefixer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// gulp-cssmin 压缩css</span>
<span class="token keyword">const</span> cssmin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-cssmin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 处理src目录下的所有scss文件，转化为css文件</span>
<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">&quot;./src/*.scss&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sass<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> sass<span class="token punctuation">.</span>logError<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        <span class="token comment">// 给css样式添加前缀</span>
        <span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">overrideBrowserslist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ie &gt; 9&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">cascade</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token comment">// 压缩css</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 将编译好的css 输出到lib目录下</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将src/fonts文件的字体文件 copy到 /lib/fonts目录下</span>
<span class="token keyword">function</span> <span class="token function">copyfont</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">&quot;./src/fonts/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib/fonts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// series创建任务列表</span>
exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> copyfont<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="gulp-给-elementui-增加一键换肤功能" tabindex="-1"><a class="header-anchor" href="#gulp-给-elementui-增加一键换肤功能" aria-hidden="true">#</a> Gulp 给 elementUI 增加一键换肤功能</h4><p><strong>总体流程</strong></p><p>1）使用<code>css var()</code>定义颜色变量</p><p>2）创建主题<code>theme.css</code>文件，存储所有的颜色变量</p><p>3）使用<code>gulp</code>将<code>theme.css</code>合并到<code>base.css</code>中，解决按需引入的情况</p><p>4）使用<code>gulp</code>将<code>index.css</code>与<code>base.css</code>合并，解决全局引入的情况</p><p><strong>步骤一：创建基础颜色变量<code>theme.css</code>文件</strong></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52a9c3cab0544603b4a7e5bf9ceb2c20~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="theme.jpg"></p><p><strong>步骤二：修改<code>packages/theme-chalk/src/common/var.scss</code>文件</strong></p><p><strong>将该文件的中定义的 scss 变量，替换成 var()变量</strong></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f5f561727524921b52a52b181a6fbb0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="var.jpg"></p><p><strong>步骤三：修改后的<code>packages/theme-chalk/gulpfile.js</code></strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-dart-sass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> autoprefixer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-autoprefixer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cssmin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-cssmin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> concat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gulp-concat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">&quot;./src/*.scss&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sass<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> sass<span class="token punctuation">.</span>logError<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">overrideBrowserslist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;ie &gt; 9&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;last 2 versions&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cascade</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 theme.css 和 lib/base.css合并成 最终的 base.css</span>
<span class="token keyword">function</span> <span class="token function">compile1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;./src/theme.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./lib/base.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;base.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将 base.css、 index.css 合并成 最终的 index.css</span>
<span class="token keyword">function</span> <span class="token function">compile2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;./lib/base.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./lib/index.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;index.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">copyfont</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">&quot;./src/fonts/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">&quot;./lib/fonts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> compile1<span class="token punctuation">,</span> compile2<span class="token punctuation">,</span> copyfont<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),R={href:"https://juejin.cn/post/7136936387181281311",target:"_blank",rel:"noopener noreferrer"},W=e(`<h2 id="脚手架" tabindex="-1"><a class="header-anchor" href="#脚手架" aria-hidden="true">#</a> 脚手架</h2><p>脚手架是开发中经常会使用的工具，比如<code>vue-cli</code>、<code>create-react-app</code>等，这些脚手架可以通过简单的命令，快速去搭建项目，让我们更专注于项目的开发</p><p>随着项目的增多、人员的扩展，大家开发的基础组件和公共方法也越来越多，希望把这些积累添加到脚手架中，当成项目模板留存下来</p><p>这样再创建项目时，就不用每次去其他项目中来回 copy</p><h3 id="手写一个-mini-版的脚手架" tabindex="-1"><a class="header-anchor" href="#手写一个-mini-版的脚手架" aria-hidden="true">#</a> 手写一个 mini 版的脚手架</h3><p>下面我们一起，手写一个 mini 版的脚手架</p><p>通过这个案例来了解脚手架的工作流程，以及使用了哪些常用工具</p><p>新建文件夹<code>my-build-cli</code>，执行<code>npm init -y</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6e8c8fb28d445afb79e914ab8edfe67~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="init-y.png"></p><h3 id="配置脚手架入口文件" tabindex="-1"><a class="header-anchor" href="#配置脚手架入口文件" aria-hidden="true">#</a> 配置脚手架入口文件</h3><p><strong>1）创建<code>bin</code>目录，该目录下创建<code>www.js</code></strong></p><p><strong><code>bin/www.js</code> 内容</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token hashbang comment">#! /usr/bin/env node</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;link 成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>注：<code>/usr/bin/env node</code> 这行的意思是使用 node 来执行此文件</em></p><p><strong>2）<code>package.json</code>中配置入口文件的路径</strong></p><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token punctuation">{</span>
  <span class="token string-literal"><span class="token string">&quot;name&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;my-build-cli&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;version&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;1.0.0&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;description&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;bin&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;./bin/www.js&quot;</span></span><span class="token punctuation">,</span> <span class="token comment">// 手动添加入口文件为 ./bin/www.js</span>
  <span class="token string-literal"><span class="token string">&quot;scripts&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string-literal"><span class="token string">&quot;test&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;keywords&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;author&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;license&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;ISC&quot;</span></span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）项目目录结构</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>my<span class="token operator">-</span>build<span class="token operator">-</span>cli
├─ bin
│  └─ www<span class="token punctuation">.</span>js
└─ <span class="token keyword">package</span><span class="token punctuation">.</span>json

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="npm-link-到全局" tabindex="-1"><a class="header-anchor" href="#npm-link-到全局" aria-hidden="true">#</a> npm link 到全局</h3><p>在控制台输入<code>npm link</code></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3e341c830934ef9b3dcbf3753ea8561~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="link.jpg"></p><p>测试是否连接成功</p><p>在控制台输入<code>my-build-cli</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3cb3c167e8c14d17a71f9bd31bd4c23d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="linksuccess.jpg"></p><p>在控制台输出<code>link 成功</code>, 项目配置成功</p><h3 id="安装脚手架所需的工具" tabindex="-1"><a class="header-anchor" href="#安装脚手架所需的工具" aria-hidden="true">#</a> 安装脚手架所需的工具</h3><p>一次性安装所需的工具</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>npm install commander inquirer download-git-repo util ora fs-extra axios
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><table><thead><tr><th>工具名称</th><th>作用</th></tr></thead><tbody><tr><td>commander</td><td>自定义命令行工具</td></tr><tr><td>inquirer</td><td>命令行交互工具</td></tr><tr><td>download-git-repo</td><td>从 git 上下载项目模板工具</td></tr><tr><td>util</td><td>download-git-repo 不支持异步调用，需要使用 util 插件的<code>util.promisify</code>进行转换</td></tr><tr><td>ora</td><td>命令行 loading 动效</td></tr><tr><td>fs-extra</td><td>提供文件操作方法</td></tr><tr><td>axios</td><td>发送接口，请求 git 上的模板列表</td></tr></tbody></table><h3 id="commander-自定义命令行工具" tabindex="-1"><a class="header-anchor" href="#commander-自定义命令行工具" aria-hidden="true">#</a> commander 自定义命令行工具</h3><p><code>commander.js</code> 是自定义命令行工具</p><p>这里用来<strong>创建<code>create</code> 命令</strong>，用户可以通过输入 <code>my-cli creat appName</code> 来创建项目</p><p><strong>修改<code>www.js</code></strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token hashbang comment">#! /usr/bin/env node</span>

<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;commander&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program
  <span class="token comment">// 创建create 命令，用户可以通过 my-cli creat appName 来创建项目</span>
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">&quot;create &lt;app-name&gt;&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 命名的描述</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">&quot;create a new project&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// create命令的选项</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">&quot;-f, --force&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;overwrite target if it exist&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行&#39;./create.js&#39;，传入项目名称和 用户选项</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="inquirer-命令行交互工具" tabindex="-1"><a class="header-anchor" href="#inquirer-命令行交互工具" aria-hidden="true">#</a> inquirer 命令行交互工具</h3><p><code>inquirer.js</code> 命令行交互工具，用来询问用户的操作，让用户输入指定的信息，或给出对应的选项让用户选择</p><p><strong>此处 inquirer 的运用场景有 2 个</strong></p><p>1）场景 1：当用户要创建的项目目录已存在时，提示用户是否要覆盖 or 取消</p><p>2）场景 2：让用户输入项目的<code>author</code>作者和项目<code>description</code>描述</p><h3 id="创建create-js" tabindex="-1"><a class="header-anchor" href="#创建create-js" aria-hidden="true">#</a> 创建<code>create.js</code></h3><p><strong><code>bin/create.js</code></strong></p><div class="language-php line-numbers-mode" data-ext="php"><pre class="language-php"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">fs</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;fs-extra&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">inquirer</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;inquirer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">Generator</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;./generator&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token operator">.</span>exports <span class="token operator">=</span> async <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// process.cwd获取当前的工作目录</span>
  <span class="token keyword">const</span> <span class="token constant">cwd</span> <span class="token operator">=</span> process<span class="token operator">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// path.join拼接 要创建项目的目录</span>
  <span class="token keyword">const</span> <span class="token constant">targetAir</span> <span class="token operator">=</span> path<span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果该目录已存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token operator">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 强制删除</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token operator">.</span>force<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      await fs<span class="token operator">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过inquirer：询问用户是否确定要覆盖 or 取消</span>
      let <span class="token punctuation">{</span> action <span class="token punctuation">}</span> <span class="token operator">=</span> await inquirer<span class="token operator">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;action&#39;</span><span class="token punctuation">,</span>
          <span class="token argument-name">type</span><span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;list&#39;</span><span class="token punctuation">,</span>
          <span class="token argument-name">message</span><span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;Target already exists&#39;</span><span class="token punctuation">,</span>
          <span class="token argument-name">choices</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              name<span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;overwrite&#39;</span><span class="token punctuation">,</span>
              <span class="token argument-name">value</span><span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;overwrite&#39;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              name<span class="token punctuation">:</span> <span class="token string single-quoted-string">&#39;cancel&#39;</span><span class="token punctuation">,</span>
              <span class="token argument-name">value</span><span class="token punctuation">:</span> <span class="token constant boolean">false</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除文件夹</span>
        await fs<span class="token operator">.</span><span class="token function">remove</span><span class="token punctuation">(</span>targetAir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token constant">args</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;./ask&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 通过inquirer，让用户输入的项目内容：作者和描述</span>
  <span class="token keyword">const</span> <span class="token constant">ask</span> <span class="token operator">=</span> await inquirer<span class="token operator">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 创建项目</span>
  <span class="token keyword">const</span> <span class="token constant">generator</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> targetAir<span class="token punctuation">,</span> ask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  generator<span class="token operator">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建ask-js" tabindex="-1"><a class="header-anchor" href="#创建ask-js" aria-hidden="true">#</a> 创建<code>ask.js</code></h3><p>配置 <code>ask</code> 选项，让用户输入作者和项目描述</p><p><strong><code>bin/create.js</code></strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 配置ask 选项</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token char">&#39;input&#39;</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token char">&#39;author&#39;</span><span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> <span class="token char">&#39;author?&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token char">&#39;input&#39;</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> &#39;description&#39;<span class="token punctuation">,</span>
    message<span class="token punctuation">:</span> &#39;description?&#39;
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建generator-js" tabindex="-1"><a class="header-anchor" href="#创建generator-js" aria-hidden="true">#</a> 创建<code>generator.js</code></h3><p><strong><code>generator.js</code>的工作流程</strong></p><p>1）通过接口获取<code>git</code>上的模板目录</p><p>2）通过<code>inquirer</code>让用户选择需要下载的项目</p><p>3）使用<code>download-git-repo</code>下载用户选择的项目模板</p><p>4）将用户创建时，将<code>项目名称、作者名字、描述</code>写入到项目模板的<code>package.json</code>文件中</p><p><strong><code>bin/generator.js</code></strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs-extra&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引入ora工具：命令行loading 动效</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;ora&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;inquirer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引入download-git-repo工具</span>
<span class="token keyword">const</span> downloadGitRepo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;download-git-repo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// download-git-repo 默认不支持异步调用，需要使用util插件的util.promisify 进行转换</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;util&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取git项目列表</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getRepolist <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 下载开始</span>
  spinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下载成功</span>
    spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 下载失败</span>
    spinner<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;Request failed ……&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建项目类</span>
<span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
  <span class="token comment">// name 项目名称</span>
  <span class="token comment">// target 创建项目的路径</span>
  <span class="token comment">// 用户输入的 作者和项目描述 信息</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> ask</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ask <span class="token operator">=</span> ask<span class="token punctuation">;</span>
    <span class="token comment">// download-git-repo 默认不支持异步调用，需要使用util插件的util.promisify 进行转换</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>downloadGitRepo <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>downloadGitRepo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取git仓库的项目列表</span>
    <span class="token keyword">const</span> repolist <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span>getRepolist<span class="token punctuation">,</span> <span class="token string">&quot;waiting fetch template&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repolist<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> repos <span class="token operator">=</span> repolist<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过inquirer 让用户选择要下载的项目模板</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> repo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;repo&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">choices</span><span class="token operator">:</span> repos<span class="token punctuation">,</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Please choose a template&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> repo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 下载用户选择的项目模板</span>
  <span class="token keyword">async</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token parameter">repo<span class="token punctuation">,</span> tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> requestUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">yuan-cli/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>repo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">wrapLoading</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>downloadGitRepo<span class="token punctuation">,</span>
      <span class="token string">&quot;waiting download template&quot;</span><span class="token punctuation">,</span>
      requestUrl<span class="token punctuation">,</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 文件入口，在create.js中 执行generator.create();</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> repo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRepo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;用户选择了&quot;</span><span class="token punctuation">,</span> repo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下载用户选择的项目模板</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>repo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下载完成后，获取项目里的package.json</span>
    <span class="token comment">// 将用户创建项目的填写的信息（项目名称、作者名字、描述），写入到package.json中</span>
    <span class="token keyword">let</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> jsonPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> <span class="token string">&quot;package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>jsonPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 读取已下载模板中package.json的内容</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>jsonPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      json<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token comment">// 让用户输入的内容 替换到 package.json中对应的字段</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        json<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ask<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//修改项目文件夹中 package.json 文件</span>
      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>jsonPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;\\t&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Generator<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建http-js" tabindex="-1"><a class="header-anchor" href="#创建http-js" aria-hidden="true">#</a> 创建<code>http.js</code></h3><p>用来发送接口，获取 git 上的模板列表</p><p><strong><code>bin/http.js</code></strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 引入axios</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取git上的项目列表</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getRepolist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.github.com/orgs/yuan-cli/repos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getRepolist<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>最终的目录结构</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a8ff4881ac046b699a36e3a82dec587~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="list.jpg"></p><h3 id="脚手架效果演示" tabindex="-1"><a class="header-anchor" href="#脚手架效果演示" aria-hidden="true">#</a> 脚手架效果演示</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0deadf8fdff741fba443bb51f439b944~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="text8.gif"></p><h3 id="脚手架发布到-npm-库" tabindex="-1"><a class="header-anchor" href="#脚手架发布到-npm-库" aria-hidden="true">#</a> 脚手架发布到 npm 库</h3><p><strong>完善 package.json</strong></p><p>1）配置<code>main</code>属性，指定包的入口 <code>&quot;main&quot;: &quot;./bin/www.js&quot;</code></p><p>2）增加<code>files</code>属性，files 用来描述当把 npm 包，作为依赖包安装的文件列表。当 npm 包发布时，files 指定的文件会被推送到 npm 服务器中</p><p>3）增加<code>description</code>、<code>keywords</code>等描述字段</p><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token punctuation">{</span>
  <span class="token string-literal"><span class="token string">&quot;name&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;my-2022-cli&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;version&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;1.1.0&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;description&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;一个mini版的脚手架&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;main&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;./bin/www.js&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;bin&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;./bin/www.js&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;scripts&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string-literal"><span class="token string">&quot;test&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;files&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">&quot;bin&quot;</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;keywords&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string-literal"><span class="token string">&quot;my-yuan-cli&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;自定义脚手架&quot;</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;author&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;海阔天空&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;license&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;ISC&quot;</span></span><span class="token punctuation">,</span>
  <span class="token string-literal"><span class="token string">&quot;dependencies&quot;</span></span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string-literal"><span class="token string">&quot;axios&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^0.24.0&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;commander&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^8.3.0&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;download-git-repo&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^3.0.2&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;fs-extra&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^10.0.0&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;inquirer&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^8.2.0&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;ora&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^5.4.1&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal"><span class="token string">&quot;util&quot;</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;^0.12.4&quot;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>增加 README.md 说明文档</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">## my-2022-cli</span>

一个 mini 版的自定义脚手架

<span class="token comment">### 安装</span>

<span class="token function">npm</span> <span class="token function">install</span> my-2022-cli <span class="token parameter variable">-g</span>

<span class="token comment">### 使用说明</span>

<span class="token number">1</span>）通过 my-2022-cli create appName 创建项目

<span class="token number">2</span>）author? 输入项目作者

<span class="token number">3</span>）description? 输入项目描述

<span class="token number">4</span>）选择项目模块 appDemo or pcDemo

<span class="token number">5</span>）安装选择的模板

<span class="token comment">### 演示示例</span>

<span class="token operator">!</span><span class="token punctuation">[</span>Image text<span class="token punctuation">]</span><span class="token punctuation">(</span>https://wx1.sinaimg.cn/mw2000/927e36bfgy1h69k6ee9z1g20rs0jfwit.gif<span class="token punctuation">)</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>发布成功后，在 npm 网站搜索<code>my-2022-cli</code></strong></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66b9c13e0604448b852dd896959659db~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="my-2022-cli.jpg"></p>`,72),V={href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxy-sea%2Fblog%2Ftree%2Fdev%2Fmy-build-cli",target:"_blank",rel:"noopener noreferrer"},J={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fmy-2022-cli",target:"_blank",rel:"noopener noreferrer"},G=e(`<h2 id="性能分析与优化" tabindex="-1"><a class="header-anchor" href="#性能分析与优化" aria-hidden="true">#</a> 性能分析与优化</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>一百用户与一百万用户的网站有着本质区别
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>随着用户的增长，任何细节的优化都变得更为重要，网站的性能差异直接影响着用户的体验</p><p>试想，如果我们在网上购物，商城页面好几秒才打开，或图片加载不出来，购物的欲望瞬间消减，抬手就去其他竞品平台了</p><p>我曾经负责过几个大型项目的整体性能优化，尽量从实战的角度聊一聊自己所理解的性能问题</p><p><strong>性能分析工具</strong></p><p>好比去医院看病一样，得了什么病，通过检测化验后才知道。网站也是一样，需要借助性能分析工具来检测</p><h3 id="lighthouse-工具" tabindex="-1"><a class="header-anchor" href="#lighthouse-工具" aria-hidden="true">#</a> Lighthouse 工具</h3><p><code>Lighthouse</code>是 Chrome 自带的性能分析工具，它能够生成一个有关页面性能的报告</p><p>通过报告我们可以知道需要采取哪些措施，来改进应用的性能和体验</p><p>并且 Lighthouse 可以对页面多方面的效果指标进行评测，并给出最佳实践的建议，以帮助开发者改进网站的质量</p><h4 id="lighthouse-拿到页面的-病情-报告" tabindex="-1"><a class="header-anchor" href="#lighthouse-拿到页面的-病情-报告" aria-hidden="true">#</a> Lighthouse 拿到页面的“病情”报告</h4><p>通过 Lighthouse 拿到网站的整体分析报告，通过报告来诊断“病情”</p>`,13),U={href:"https://juejin.cn/",target:"_blank",rel:"noopener noreferrer"},$=n("code",null,"Lighthouse",-1),Y=n("code",null,"Generate report",-1),K=e(`<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a45f99f0e13343949f3e611f5e7b625d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="Lighthouse.jpg"></p><p><strong>Lighthouse 能够生成一份该网站的报告，比如下图：</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2257a3245dc401e8f5b7e2430007c41~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="performance.jpg"></p><p><strong>这里重点关注<code>Performance性能评分</code></strong></p><p>性能评分的分值区间是 0 到 100，如果出现 0 分，通常是在运行 Lighthouse 时发生了错误，满分 100 分代表了网站已经达到了 98 分位值的数据，而 50 分则对应 75 分位值的数据</p><p>小伙伴看看自己开发的项目得分是多少，处于什么样的水平</p><h4 id="lighthouse-给出-opportunities-优化建议" tabindex="-1"><a class="header-anchor" href="#lighthouse-给出-opportunities-优化建议" aria-hidden="true">#</a> Lighthouse 给出 Opportunities 优化建议</h4><p>Lighthouse 会针对当前网站，给出一些<code>Opportunities</code>优化建议</p><p><strong>Opportunities 指的是优化机会，它提供了详细的建议和文档，来解释低分的原因，帮助我们具体进行实现和改进</strong></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7de10b4870824a61b81780cf46ed1a02~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="opportunity.jpg"></p><p>举一个我曾开发过的一个项目，以下是</p><p><strong>Opportunities 给出优化建议列表</strong></p><table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>Remove unused JavaScript</td><td>去掉无用 js 代码</td></tr><tr><td>Preload key requests</td><td>首页资源 preload 预加载</td></tr><tr><td>Remove unused CSS</td><td>去掉无用 css 代码</td></tr><tr><td>Serve images in next-gen formats</td><td>使用新的图片格式，比如 webp 相对 png jpg 格式体积更小</td></tr><tr><td>Efficiently encode images</td><td>比如压缩图片大小</td></tr><tr><td>Preconnect to required origins</td><td>使用 preconnect or dns-prefetch DNS 预解析</td></tr></tbody></table><h4 id="lighthouse-给出-diagnostics-诊断问题列表" tabindex="-1"><a class="header-anchor" href="#lighthouse-给出-diagnostics-诊断问题列表" aria-hidden="true">#</a> Lighthouse 给出 Diagnostics 诊断问题列表</h4><p><strong><code>Diagnostics</code> 指的是现在存在的问题，为进一步改善性能的验证和调整给出了指导</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b808a0335cdd4eb7a43b20b00b16e68a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="DiagNo.jpg"></p><p><strong>Diagnostics 诊断问题列表</strong></p><table><thead><tr><th>问题</th><th>影响</th></tr></thead><tbody><tr><td>A long cache lifetime can speed up repeat visits to your page</td><td>这些资源需要提供长的缓存期，现发现图片都是用的协商缓存，显然不合理</td></tr><tr><td>Image elements do not have explicit width and height</td><td>给图片设置具体的宽高，减少 cls 的值</td></tr><tr><td>Avoid enormous network payloads</td><td>资源太大增加网络负载</td></tr><tr><td>Minimize main-thread work</td><td>最小化主线程 这里会执行解析 Html、样式计算、布局、绘制、合成等动作</td></tr><tr><td>Reduce JavaScript execution time</td><td>减少非必要 js 资源的加载，减少必要 js 资源的大小</td></tr><tr><td>Avoid large layout shifts</td><td>避免大的布局变化，从中可以看到影响布局变化最大的元素</td></tr></tbody></table><p><strong><code>这些Opportunities建议和Diagnostics诊断问题是非常具体且有效的（亲测），开发者可以根据这些建议，一条条去修改或优化</code></strong></p><h4 id="lighthouse-列出-performance-各指标得分" tabindex="-1"><a class="header-anchor" href="#lighthouse-列出-performance-各指标得分" aria-hidden="true">#</a> Lighthouse 列出 Performance 各指标得分</h4><p>Performance 列出了<code>FCP、SP、LCP、TTI、TBI、CLS</code> 六个指标的用时和得分情况</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>下文会聊一聊这些指标的用法与作用
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af0472178da940eba7dd95bb6ef7c597~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="performance1.jpg"></p>`,23),Q={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.cnblogs.com%2Fwenxuehai%2Fp%2F14236426.html",target:"_blank",rel:"noopener noreferrer"},X=n("h3",{id:"web-vitals-官方标准",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#web-vitals-官方标准","aria-hidden":"true"},"#"),s(" Web-vitals 官方标准")],-1),Z={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fweb-vitals",target:"_blank",rel:"noopener noreferrer"},nn=n("strong",null,"良好网站的基本指标",-1),sn=e(`<p>过去要衡量一个网站的好坏，需要使用的指标太多了，现在我们可以将重点聚焦于 Web Vitals 指标的表现即可</p><p><strong>官方指标标准</strong></p><table><thead><tr><th>指标</th><th>作用</th><th>标准</th></tr></thead><tbody><tr><td>FCP(First Contentful Paint)</td><td>首次内容绘制时间</td><td>标准 ≤1s</td></tr><tr><td>LCP(Largest Contentful Paint)</td><td>最大内容绘制时间</td><td>标准 ≤2 秒</td></tr><tr><td>FID(first input delay)</td><td>首次输入延迟，标准是用户触发后，到浏览器响应时间</td><td>标准 ≤100ms</td></tr><tr><td>CLS(Cumulative Layout Shift)</td><td>累积布局偏移</td><td>标准 ≤0.1</td></tr><tr><td>TTFB(Time to First Byte)</td><td>页面发出请求，到接收第一个字节所花费的毫秒数(首字节时间)</td><td>标准&lt;= 100 毫秒</td></tr></tbody></table><p><strong>我们将 Lighthouse 中 Performance 列出的指标表现，与官方指标标准做对比，可以发现页面哪些指标超出了范围</strong></p><h3 id="performance-工具" tabindex="-1"><a class="header-anchor" href="#performance-工具" aria-hidden="true">#</a> Performance 工具</h3><p>通过 Lighthouse 我们知道了页面整体的性能得分，但是页面打开慢或者卡顿的瓶颈在哪里？</p><p>具体是<code>加载资源慢</code>、<code>dom渲染慢</code>、还是<code>js执行慢</code>呢？</p><p>chrome 浏览器提供的<code>performance</code>是常用来查看网页性能的工具，通过该工具，我们可以知道页面在浏览器运行时的性能表现</p><h4 id="performance-寻找性能瓶颈" tabindex="-1"><a class="header-anchor" href="#performance-寻找性能瓶颈" aria-hidden="true">#</a> Performance 寻找性能瓶颈</h4><p>打开 Chrome 浏览器控制台，选择<code>Performance</code>选项，点击左侧<code>reload图标</code></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ad95e570f854f62a5affae73899dfaf~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="perfromance1.gif"></p><p><strong>Performance 面板可以记录和分析页面在运行时的所有活动，大致分为以下 4 个区域</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/733069bb8c6d4d4c90b3df24230b0e92~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="performance2.png"></p><h4 id="performance-各区域功能介绍" tabindex="-1"><a class="header-anchor" href="#performance-各区域功能介绍" aria-hidden="true">#</a> Performance 各区域功能介绍</h4><p><strong>1）FPS</strong></p><p><strong>FPS(Frames Per Second)，表示每秒传输帧数，是用来分析<code>页面是否卡顿</code>的一个主要性能指标</strong></p><p>如下图所示，<code>绿色的长条越高，说明FPS越高，用户体验越好</code></p><p>如果发现了<code>一个红色的长条，那么就说明这些帧存在严重问题</code>，可能会造成页面卡顿</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/daa866b933004dafa5c06c2cc915a35d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="FPS.png"></p><p><strong>2）NET</strong></p><p><strong>NET 记录资源的等待、下载、执行时间，每条彩色横杠表示一种资源</strong></p><p>横杠越长，检索资源所需的时间越长。每个横杠的浅色部分表示等待时间（从请求资源到第一个字节下载完成的时间）</p><p>Network 的颜色说明：白色表示等待的颜色、浅黄色表示请求的时间、深黄色表示下载的时间</p><p><strong>在这里，我们可以看到所有资源的加载过程，有两个地方重点关注：</strong></p><p>1）资源等待的时间是否过长（标准 ≤100ms）</p><p>2）资源文件体积是否过大，造成加载很慢（就要考虑如何拆分该资源）</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4f36cb8f3634b109b4737a48cb61429~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="net.png"></p><p><strong>3）火焰图</strong></p><p><strong>火焰图（Flame Chart）用来可视化 CPU 堆栈信息记录</strong></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2b5e759df83476f8f8238cbe66be66b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="fire.png"> 1）Network: 表示加载了哪些资源 2）Frames：表示每幅帧的运行情况 3）Timings: 记录页面中关键指标的时间 4）<code>Main:表示主线程（重点，下文会详细介绍）</code> 5）GPU:表示 GPU 占用情况</p><p><strong>4）统计汇总</strong></p><p>Summary: 表示各指标时间占用统计报表</p><div class="language-makefile line-numbers-mode" data-ext="makefile"><pre class="language-makefile"><code><span class="token target symbol">1）Loading</span><span class="token punctuation">:</span> 加载时间
<span class="token target symbol">2）Scripting</span><span class="token punctuation">:</span> js计算时间
<span class="token target symbol">3）Rendering</span><span class="token punctuation">:</span> 渲染时间
<span class="token target symbol">4）Painting</span><span class="token punctuation">:</span> 绘制时间
<span class="token target symbol">5）Other</span><span class="token punctuation">:</span> 其他时间
<span class="token target symbol">6）Idle</span><span class="token punctuation">:</span> 浏览器闲置时间

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b034f036bde34c9f9667acaaa2db0b26~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="sum.jpg"></p><h4 id="performance-main-性能瓶颈的突破口" tabindex="-1"><a class="header-anchor" href="#performance-main-性能瓶颈的突破口" aria-hidden="true">#</a> Performance Main 性能瓶颈的突破口</h4><p><strong>Main 表示主线程，主要负责</strong></p><p>1）Javascript 的计算与执行 2）CSS 样式计算 3）Layout 布局计算 4）将页面元素绘制成位图（paint），也就是光栅化（Raster）</p><p><strong>展开 Main,可以发现很多<code>红色三角（long task）</code>，这些执行时间超过 <code>50ms</code>就属于<code>长任务</code>，会造成页面卡顿，严重时会造成页面卡死</strong></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fff398aabc3492589d35bec1d095ab2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="main.jpg"></p><p>展开其中一个红色三角，Devtools 在<code>Summary</code>面板里展示了更多关于这个事件的信息</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c5aeed2a25b426f94747c370329fb97~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="app.jpg"></p><p><strong>在 summary 面板里点击<code>app.js</code>链接，Devtools 可以跳转到需要优化的代码处</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5777d8ab909943e18b960bf89adfc6e1~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="source.jpg"></p><p>下面我们需要结合自己的代码逻辑，去判断这块代码为什么执行时间超长？</p><p><strong>如何去解决或优化这些<code>long task</code>，从而解决去页面的性能瓶颈</strong></p>`,45),an={href:"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F29879682",target:"_blank",rel:"noopener noreferrer"},tn={href:"https://juejin.cn/post/6892003555818143752#heading-26",target:"_blank",rel:"noopener noreferrer"},en={href:"https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fqq_38128179%2Farticle%2Fdetails%2F104491149",target:"_blank",rel:"noopener noreferrer"},pn=e(`<h2 id="性能监控" tabindex="-1"><a class="header-anchor" href="#性能监控" aria-hidden="true">#</a> 性能监控</h2><p>项目发布生产后，用户使用时的性能如何，页面整体的打开速度是多少、白屏时间多少，FP、FCP、LCP、FID、CLS 等指标，要设置多大的阀值呢，才能满足<code>TP50、TP90、TP99</code>的要求呢？</p><blockquote><p>TP 指标: 总次数 * 指标数 = 对应 TP 指标的值。</p><p>设置每个指标的阀值，比如 FP 指标，设置阀值为 1s，要求 Tp95，即 95%的 FP 指标，要在 1s 以下，剩余 5%的指标超过 1s</p><p>TP50 相对较低，TP90 则比较高，TP99，TP999 则对性能要求很高</p></blockquote><p>这里就需要性能监控，采集到用户的页面数据</p><h3 id="性能指标的计算" tabindex="-1"><a class="header-anchor" href="#性能指标的计算" aria-hidden="true">#</a> 性能指标的计算</h3><p>常用的两种方式：</p><p><strong>方式一：通过 web-vitals 官方库进行计算</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> onLCP<span class="token punctuation">,</span> onFID<span class="token punctuation">,</span> onCLS <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;web-vitals&quot;</span><span class="token punctuation">;</span>

<span class="token function">onCLS</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">onFID</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">onLCP</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>方式二：通过<code>performance api</code>进行计算</strong></p><p>下面聊一下 performance api 来计算各种指标</p><p>打开任意网页，在控制台中输入 performance 回车，可以看到一系列的参数，</p><h3 id="performance-timing" tabindex="-1"><a class="header-anchor" href="#performance-timing" aria-hidden="true">#</a> performance.timing</h3><p>重点看下<code>performance.timing</code>，记录了页面的各个关键时间点</p><table><thead><tr><th>时间</th><th>作用</th></tr></thead><tbody><tr><td><code>navigationStart</code></td><td>（可以理解为该页面的起始时间）同一个浏览器上下文的上一个文档卸载结束时的时间戳，如果没有上一个文档，这个值会和 fetchStart 相同</td></tr><tr><td>unloadEventStart</td><td>unload 事件抛出时的时间戳,如果没有上一个文档，这个值会是 0</td></tr><tr><td>unloadEventEnd</td><td>unload 事件处理完成的时间戳,如果没有上一个文档，这个值会是 0</td></tr><tr><td>redirectStart</td><td>第一个 HTTP 重定向开始时的时间戳，没有重定向或者重定向中的不同源，这个值会是 0</td></tr><tr><td>redirectEnd</td><td>最后一个 HTTP 重定向开始时的时间戳，没有重定向或者重定向中的不同源，这个值会是 0</td></tr><tr><td>fetchStart</td><td>浏览器准备好使用 HTTP 请求来获取文档的时间戳。发送在检查缓存之前</td></tr><tr><td>domainLookupStart</td><td>域名查询开始的时间戳，如果使用了持续连接或者缓存，则与 fetchStart 一致</td></tr><tr><td>domainLookupEnd</td><td>域名查询结束的时间戳，如果使用了持续连接或者缓存，则与 fetchStart 一致</td></tr><tr><td>connectStart</td><td>HTTP 请求开始向服务器发送时的时间戳，如果使用了持续连接，则与 fetchStart 一致</td></tr><tr><td>connectEnd</td><td>浏览器与服务器之间连接建立（所有握手和认证过程全部结束）的时间戳，如果使用了持续连接，则与 fetchStart 一致</td></tr><tr><td>secureConnectionStart</td><td>浏览器与服务器开始安全连接握手时的时间戳，如果当前网页不需要安全连接，这个值会是 0</td></tr><tr><td><code>requestStart</code></td><td>浏览器向服务器发出 HTTP 请求的时间戳</td></tr><tr><td><code>responseStart</code></td><td>浏览器从服务器收到（或从本地缓存读取）第一个字节时的时间戳</td></tr><tr><td>responseEnd</td><td>浏览器从服务器收到（或从本地缓存读取）最后一个字节时（如果在此之前 HTTP 连接已经关闭，则返回关闭时）的时间戳</td></tr><tr><td><code>domLoading</code></td><td>当前网页 DOM 结构开始解析时的时间戳</td></tr><tr><td>domInteractive</td><td>当前网页 DOM 结构解析完成，开始加载内嵌资源时的时间戳</td></tr><tr><td>domContentLoadedEventStart</td><td>需要被执行的脚本已经被解析的时间戳</td></tr><tr><td>domContentLoadedEventEnd</td><td>需要立即执行的脚本已经被执行的时间戳</td></tr><tr><td><code>domComplete</code></td><td>当前文档解析完成的时间戳</td></tr><tr><td>loadEventStart</td><td>load 事件被发送时的时间戳，如果这个事件还未被发送，它的值将会是 0</td></tr><tr><td><code>loadEventEnd</code></td><td>load 事件结束时的时间戳，如果这个事件还未被发送，它的值将会是 0</td></tr></tbody></table><h3 id="白屏时间-fp" tabindex="-1"><a class="header-anchor" href="#白屏时间-fp" aria-hidden="true">#</a> 白屏时间 FP</h3><p>白屏时间 FP（First Paint）指的是从用户输入 url 的时刻开始计算，一直到页面有内容展示出来的时间节点，<code>标准≤2s</code></p><p><strong>这个过程包括 dns 查询、建立 tcp 连接、发送 http 请求、返回 html 文档、html 文档解析</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;first-paint&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
       <span class="token comment">// 其中startTime 就是白屏时间</span>
       <span class="token keyword">let</span> <span class="token constant">FP</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span>
<span class="token comment">// buffered 属性表示是否观察缓存数据，也就是说观察代码添加时机比事件触发时机晚也没关系。</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;paint&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="首次内容绘制时间-fcp" tabindex="-1"><a class="header-anchor" href="#首次内容绘制时间-fcp" aria-hidden="true">#</a> 首次内容绘制时间 FCP</h3><p>FCP(First Contentful Paint) 表示页面任一部分渲染完成的时间，<code>标准≤1s</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 计算方式：</span>
<span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;first-contentful-paint&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 计算首次内容绘制时间</span>
    <span class="token keyword">let</span> <span class="token constant">FCP</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最大内容绘制时间-lcp" tabindex="-1"><a class="header-anchor" href="#最大内容绘制时间-lcp" aria-hidden="true">#</a> 最大内容绘制时间 LCP</h3><p>LCP(Largest Contentful Paint)表示最大内容绘制时间，<code>标准≤2 秒</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 计算方式：</span>
<span class="token keyword">const</span> <span class="token function-variable function">entryHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 最大内容绘制时间</span>
    <span class="token keyword">let</span> <span class="token constant">LCP</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span>entryHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;largest-contentful-paint&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="累积布局偏移值-cls" tabindex="-1"><a class="header-anchor" href="#累积布局偏移值-cls" aria-hidden="true">#</a> 累积布局偏移值 CLS</h3><p>CLS(Cumulative Layout Shift) 表示累积布局偏移，<code>标准≤0.1</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// cls为累积布局偏移值</span>
<span class="token keyword">let</span> cls <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>hadRecentInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cls <span class="token operator">+=</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;layout-shift&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="首字节时间-ttfb" tabindex="-1"><a class="header-anchor" href="#首字节时间-ttfb" aria-hidden="true">#</a> 首字节时间 TTFB</h3><p>平常所说的<code>TTFB</code>，默认指导航请求的<code>TTFB</code></p><p>导航请求：在浏览器切换页面时创建，从导航开始到该请求返回 HTML</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">window.onload</span> <span class="token punctuation">=</span> <span class="token value attr-value">function () {</span>
  // 首字节时间
  <span class="token key attr-name">let TTFB</span> <span class="token punctuation">=</span> <span class="token value attr-value">responseStart - navigationStart;</span>
};

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="首次输入延迟-fid" tabindex="-1"><a class="header-anchor" href="#首次输入延迟-fid" aria-hidden="true">#</a> 首次输入延迟 FID</h3><p>FID（first input delay）首次输入延迟，标准是用户触发后，浏览器的响应时间， <code>标准≤100ms</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> entryList<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 计算首次输入延迟时间</span>
    <span class="token keyword">const</span> <span class="token constant">FID</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span>processingStart <span class="token operator">-</span> entry<span class="token punctuation">.</span>startTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;first-input&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">buffered</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>FID 推荐使用 web-vitals 库，因为官方兼容了很多场景</p><h3 id="首页加载时间" tabindex="-1"><a class="header-anchor" href="#首页加载时间" aria-hidden="true">#</a> 首页加载时间</h3><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code><span class="token key attr-name">window.onload</span> <span class="token punctuation">=</span> <span class="token value attr-value">function () {</span>
  // 首页加载时间
  <span class="token key attr-name">// domComplete 是document的readyState</span> <span class="token punctuation">=</span> <span class="token value attr-value">complete（完成）的状态</span>
  <span class="token key attr-name">let firstScreenTime</span> <span class="token punctuation">=</span> <span class="token value attr-value">performance.timing.domComplete - performance.timing.navigationStart;</span>
};

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="首屏加载时间" tabindex="-1"><a class="header-anchor" href="#首屏加载时间" aria-hidden="true">#</a> 首屏加载时间</h3><p><strong>首屏加载时间和首页加载时间不一样</strong>，首屏指的是用户看到屏幕内页面渲染完成的时间</p><p>比如首页很长需要好几屏展示，这种情况下屏幕以外的元素不考虑在内</p><p><strong>计算首屏加载时间流程</strong></p><p>1）利用<code>MutationObserver</code>监听<code>document</code>对象，每当 dom 变化时触发该事件</p><p>2）判断监听的 dom 是否在首屏内，如果在首屏内，将该 dom 放到指定的数组中，记录下当前 dom 变化的时间点</p><p>3）在 MutationObserver 的 callback 函数中，通过防抖函数，监听<code>document.readyState</code>状态的变化</p><p>4）当<code>document.readyState === &#39;complete&#39;</code>，停止定时器和 取消对 document 的监听</p><p>5）遍历存放 dom 的数组，找出最后变化节点的时间，用该时间点减去<code>performance.timing.navigationStart</code> 得出首屏的加载时间</p><p><strong>定义 performance.js</strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>// firstScreenPaint为首屏加载时间的变量
<span class="token key attr-name">let firstScreenPaint</span> <span class="token punctuation">=</span> <span class="token value attr-value">0;</span>
// 页面是否渲染完成
<span class="token key attr-name">let isOnLoaded</span> <span class="token punctuation">=</span> <span class="token value attr-value">false;</span>
let timer;
let observer;

<span class="token key attr-name">// 定时器循环监听dom的变化，当document.readyState</span> <span class="token punctuation">=</span><span class="token value attr-value">== &#39;complete&#39;时，停止监听</span>
function checkDOMChange(callback) {
  cancelAnimationFrame(timer);
  <span class="token key attr-name">timer</span> <span class="token punctuation">=</span> <span class="token value attr-value">requestAnimationFrame(() =&gt; {</span>
    <span class="token key attr-name">if (document.readyState</span> <span class="token punctuation">=</span><span class="token value attr-value">== &#39;complete&#39;) {</span>
      <span class="token key attr-name">isOnLoaded</span> <span class="token punctuation">=</span> <span class="token value attr-value">true;</span>
    }
    if (isOnLoaded) {
      // 取消监听
      observer &amp;&amp; observer.disconnect();

      <span class="token key attr-name">// document.readyState</span> <span class="token punctuation">=</span><span class="token value attr-value">== &#39;complete&#39;时，计算首屏渲染时间</span>
      <span class="token key attr-name">firstScreenPaint</span> <span class="token punctuation">=</span> <span class="token value attr-value">getRenderTime();</span>
      <span class="token key attr-name">entries</span> <span class="token punctuation">=</span> <span class="token value attr-value">null;</span>

      // 执行用户传入的callback函数
      callback &amp;&amp; callback(firstScreenPaint);
    } else {
      checkDOMChange();
    }
  });
}
function getRenderTime() {
  <span class="token key attr-name">let startTime</span> <span class="token punctuation">=</span> <span class="token value attr-value">0;</span>
  <span class="token key attr-name">entries.forEach((entry)</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; {</span>
    if (entry.startTime &gt; startTime) {
      <span class="token key attr-name">startTime</span> <span class="token punctuation">=</span> <span class="token value attr-value">entry.startTime;</span>
    }
  });
  // performance.timing.navigationStart 页面的起始时间
  return startTime - performance.timing.navigationStart;
}
<span class="token key attr-name">const viewportWidth</span> <span class="token punctuation">=</span> <span class="token value attr-value">window.innerWidth;</span>
<span class="token key attr-name">const viewportHeight</span> <span class="token punctuation">=</span> <span class="token value attr-value">window.innerHeight;</span>
// dom 对象是否在屏幕内
function isInScreen(dom) {
  <span class="token key attr-name">const rectInfo</span> <span class="token punctuation">=</span> <span class="token value attr-value">dom.getBoundingClientRect();</span>
  if (rectInfo.left &lt; viewportWidth &amp;&amp; rectInfo.top &lt; viewportHeight) {
    return true;
  }
  return false;
}
<span class="token key attr-name">let entries</span> <span class="token punctuation">=</span> <span class="token value attr-value">[];</span>

// 外部通过callback 拿到首屏加载时间
export default function observeFirstScreenPaint(callback) {
  <span class="token key attr-name">const ignoreDOMList</span> <span class="token punctuation">=</span> <span class="token value attr-value">[&#39;STYLE&#39;, &#39;SCRIPT&#39;, &#39;LINK&#39;];</span>
  <span class="token key attr-name">observer</span> <span class="token punctuation">=</span> <span class="token value attr-value">new window.MutationObserver((mutationList) =&gt; {</span>
    checkDOMChange(callback);
    <span class="token key attr-name">const entry</span> <span class="token punctuation">=</span> <span class="token value attr-value">{ children: [] };</span>
    for (const mutation of mutationList) {
      if (mutation.addedNodes.length &amp;&amp; isInScreen(mutation.target)) {
        for (const node of mutation.addedNodes) {
          // 忽略掉以上标签的变化
          <span class="token key attr-name">if (node.nodeType</span> <span class="token punctuation">=</span><span class="token value attr-value">== 1 &amp;&amp; !ignoreDOMList.includes(node.tagName) &amp;&amp; isInScreen(node)) {</span>
            entry.children.push(node);
          }
        }
      }
    }

    if (entry.children.length) {
      entries.push(entry);
      <span class="token key attr-name">entry.startTime</span> <span class="token punctuation">=</span> <span class="token value attr-value">new Date().getTime();</span>
    }
  });
  observer.observe(document, {
    childList: true, // 监听添加或删除子节点
    subtree: true, // 监听整个子树
    characterData: true, // 监听元素的文本是否变化
    attributes: true // 监听元素的属性是否变化
  });
}


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>外部引入使用</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> observeFirstScreenPaint <span class="token keyword">from</span> <span class="token string">&quot;./performance&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 通过回调函数，拿到首屏加载时间</span>
<span class="token function">observeFirstScreenPaint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;首屏加载时间&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dom-渲染时间和-window-onload-时间" tabindex="-1"><a class="header-anchor" href="#dom-渲染时间和-window-onload-时间" aria-hidden="true">#</a> DOM 渲染时间和 window.onload 时间</h3><p>DOM 的渲染的时间和 window.onload 执行的时间不是一回事</p><p><strong>DOM 渲染的时间</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>DOM渲染的时间 =  performance.timing.domComplete - performance.timing.domLoading

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>window.onload 要晚于 DOM 的渲染，window.onload 是页面中所有的资源都加载后才执行（包括图片的加载）</p><p><strong>window.onload 的时间</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>window<span class="token punctuation">.</span>onload的时间 <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>loadEventEnd<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="计算资源的缓存命中率" tabindex="-1"><a class="header-anchor" href="#计算资源的缓存命中率" aria-hidden="true">#</a> 计算资源的缓存命中率</h3><p><strong>缓存命中率：从缓存中得到数据的请求数与所有请求数的比率</strong></p><p>理想状态是缓存命中率越高越好，缓存命中率越高说明网站的缓存策略越有效，用户打开页面的速度也会相应提高</p><p><strong>如何判断该资源是否命中缓存？</strong></p><p>1）通过<code>performance.getEntries()</code>找到所有资源的信息</p><p>2）在这些资源对象中有一个<code>transferSize</code> 字段，它表示获取资源的大小，包括响应头字段和响应数据的大小</p><p>3）如果这个值为 0，说明是从缓存中直接读取的（强制缓存）</p><p>4）如果这个值不为 0，但是<code>encodedBodySize</code> 字段为 0，说明它走的是协商缓存（<code>encodedBodySize 表示请求响应数据 body 的大小</code>）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isCache</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 直接从缓存读取或 304</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    entry<span class="token punctuation">.</span>transferSize <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>transferSize <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> entry<span class="token punctuation">.</span>encodedBodySize <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>将<code>所有命中缓存的数据 / 总数据</code> 就能得出<code>缓存命中率</code></strong></p><h3 id="性能数据上报" tabindex="-1"><a class="header-anchor" href="#性能数据上报" aria-hidden="true">#</a> 性能数据上报</h3><p><strong>上报方式</strong></p><p>一般使用<code>图片打点</code>的方式，通过动态创建 img 标签的方式，new 出像素为<code>1x1 px</code>的<code>gif Image</code>（gif 体积最小）对象就能发起请求，可以跨域、不需要等待服务器返回数据</p><p><strong>上报时机</strong></p><p>可以利用<code>requestIdleCallback</code>，浏览器空闲的时候上报，好处是：不阻塞其他流程的进行</p><p>如果浏览器不支持该<code>requestIdleCallback</code>，就使用<code>setTimeout</code>上报</p><div class="language-scss line-numbers-mode" data-ext="scss"><pre class="language-scss"><code><span class="token comment">// 优先使用requestIdleCallback</span>
if <span class="token punctuation">(</span>window.requestIdleCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window.<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token selector">=&gt; </span><span class="token punctuation">{</span>
      <span class="token comment">// 获取浏览器的剩余空闲时间</span>
      console.<span class="token function">log</span><span class="token punctuation">(</span>deadline.<span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">report</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// timeout设置为1000，如果在1000ms内没有执行该后调，在下次空闲时间时，callback会强制执行</span>
    <span class="token punctuation">{</span> <span class="token property">timeout</span><span class="token punctuation">:</span> 1000 <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token selector">else </span><span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token selector">=&gt; </span><span class="token punctuation">{</span>
    <span class="token function">report</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报数据</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="内存分析与优化" tabindex="-1"><a class="header-anchor" href="#内存分析与优化" aria-hidden="true">#</a> 内存分析与优化</h2><p>性能分析很火，但内存分析相比就低调很多了</p><p>举一个我之前遇到的情况，客户电脑配置低，打开公司开发的页面，经常出现页面崩溃</p><p>调查原因，就是因为页面内存占用太大，客户打开几个页面后，内存直接拉满，也是经过这件事，我开始重视内存分析与优化</p><p>下面，聊一聊内存这块有哪些知识</p><h3 id="memory-工具" tabindex="-1"><a class="header-anchor" href="#memory-工具" aria-hidden="true">#</a> Memory 工具</h3><p>Memory 工具，通过<code>内存快照</code>的方式，分析当前页面的内存使用情况</p><p><strong>Memory 工具使用流程</strong></p><p>1）打开 chrome 浏览器控制台，选择<code>Memory</code>工具</p><p>2）点击左侧<code>start按钮</code>，刷新页面，开始录制的<code>JS堆动态分配时间线</code>，会生成页面加载过程内存变化的柱状统计图（蓝色表示未回收，灰色表示已回收）</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aab5505602aa45498105fed8b8b20806~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="memory.jpg"></p><p><strong>Memory 工具中的关键项</strong></p><p><strong>关键项</strong></p><p>Constructor：对象的类名； Distance：对象到根的引用层级； Objects Count：对象的数量； Shallow Size： 对象本身占用的内存，不包括引用的对象所占内存； Retained Size： 对象所占总内存，包含引用的其他对象所占内存； Retainers：对象的引用层级关系</p><p><strong>通过一段测试代码来了解 Memory 工具各关键性的关系</strong></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 测试代码</span>
<span class="token keyword">class</span> <span class="token class-name">Jane</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Tom</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>jane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Tom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a05c8093ada4d19a71a78c225b7e013~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="cpudemo.jpg"></p><p>shallow size 和 retained size 的区别，以用红框里的 <code>Tom</code> 和 <code>Jane</code> 更直观的展示</p><p>Tom 的 shallow 占了 32M，retained 占用了 56M，这是因为 retained 包括了引用的指针对应的内存大小，即 <code>tom.jane</code> 所占用的内存</p><p>所以 Tom 的 retained 总和比 shallow 多出来的 24M，正好跟 Jane 占用的 24M 相同</p><p>retained size 可以理解为当回收掉该对象时可以释放的内存大小，在内存调优中具有重要参考意义</p><h3 id="内存分析的关键点" tabindex="-1"><a class="header-anchor" href="#内存分析的关键点" aria-hidden="true">#</a> 内存分析的关键点</h3><p>找到内存最高的节点，分析这些时刻执行了哪些代码，发生了什么操作，尽可能去优化它们</p><p>1）从柱状图中找到最高的点，重点分析该时间内造成内存变大的原因</p><p>2）按照<code>Retainers size</code>（总内存大小）排序，点击展开内存最高的哪一项，点击展开构造函数，可以看到所有构造函数相关的对象实例</p><p>3）选中构造函数，底部会显示对应源码文件，点击源码文件，可以跳转到具体的代码，这样我们就知道是哪里的代码造成内存过大</p><p>4）结合具体的代码逻辑，来判断这块内存变大的原因，重点是如何去优化它们，降低内存的使用大小</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f4655f8d064457ba2624c9806d7a094~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="retainedSize.jpg"></p><p><strong>点击<code>keyghost.js</code>可以跳转到具体的源码</strong></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/080b6071cd4946729a3bc68c22a588e8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="localkey.png"></p><h3 id="内存泄露的情况" tabindex="-1"><a class="header-anchor" href="#内存泄露的情况" aria-hidden="true">#</a> 内存泄露的情况</h3><p>1）意外的全局变量， 挂载到 window 上全局变量 2）遗忘的定时器，定时器没有清除 3）闭包不当的使用</p><h3 id="内存分析总结" tabindex="-1"><a class="header-anchor" href="#内存分析总结" aria-hidden="true">#</a> 内存分析总结</h3><p>1）利用 Memory 工具，了解页面整体的内存使用情况</p><p>2）通过 JS 堆动态分配时间线，找到内存最高的时刻</p><p>3）按照 Retainers size（总内存大小）排序，点击展开内存最高的前几项，分析由于哪个函数操作导致了内存过大，甚至是内存泄露</p><p>4）结合具体的代码，去解决或优化内存变大的情况</p>`,111),on={href:"https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fc11073138%2Farticle%2Fdetails%2F84700482",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fc11073138%2Farticle%2Fdetails%2F84728132%3Fspm%3D1001.2014.3001.5502",target:"_blank",rel:"noopener noreferrer"},ln={href:"https://juejin.cn/post/6844904038064979981",target:"_blank",rel:"noopener noreferrer"},un=e('<h2 id="项目优化总结" tabindex="-1"><a class="header-anchor" href="#项目优化总结" aria-hidden="true">#</a> 项目优化总结</h2><p><strong>优化的本质：响应更快，展示更快</strong></p><p>更详细的说，是指在用户输入 url，到页面完整展示出来的过程中，通过各种优化策略和方法，让页面加载更快；在用户使用过程中，让用户的操作响应更及时，有更好的用户体验</p><h3 id="经典-雅虎军规" tabindex="-1"><a class="header-anchor" href="#经典-雅虎军规" aria-hidden="true">#</a> 经典：雅虎军规</h3><p>很多前端优化准则都是围绕着这个展开</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f752944cbfe742449b12fef3056c4b43~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="雅虎35条军规.jpg"></p><h3 id="优化建议" tabindex="-1"><a class="header-anchor" href="#优化建议" aria-hidden="true">#</a> 优化建议</h3><p>结合我曾经负责优化的项目实践，在下面总结了一些经验与方法，提供给大家参考</p><h4 id="_1、分析打包后的文件" tabindex="-1"><a class="header-anchor" href="#_1、分析打包后的文件" aria-hidden="true">#</a> 1、分析打包后的文件</h4>',9),rn={href:"https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fwebpack-bundle-analyzer",target:"_blank",rel:"noopener noreferrer"},dn=e(`<p>我们要清楚的知道项目中使用了哪些三方依赖，以及依赖的作用。特别对于体积大的依赖，分析是否能优化</p><p>比如：组件库如<code>elementUI</code>的按需引入、<code>Swiper轮播图</code>组件打包后的体积约 200k，看是否能替换成体积更小的插件、<code>momentjs</code>去掉无用的语言包等</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ee7ed860fbd435187629e41cafb4ca6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?" alt="vendors.png"></p><h4 id="_2、合理处理公共资源" tabindex="-1"><a class="header-anchor" href="#_2、合理处理公共资源" aria-hidden="true">#</a> 2、合理处理公共资源</h4><p>如果项目支持 CDN，可以配置<code>externals</code>，将<code>Vue、Vue-router、Vuex、echarts</code>等公共资源，通过 CDN 的方式引入，不打到项目里边</p><p>如果项目不支持 CDN，可以使用<code>DllPlugin</code>动态链接库，将业务代码和公共资源代码相分离，公共资源单独打包，给这些公共资源设置强缓存（公共资源基本不会变），这样以后可以只打包业务代码，提升打包速度</p><h4 id="_3、首屏必要资源-preload-预加载-和-dns-预解析" tabindex="-1"><a class="header-anchor" href="#_3、首屏必要资源-preload-预加载-和-dns-预解析" aria-hidden="true">#</a> 3、首屏必要资源 preload 预加载 和 DNS 预解析</h4><p><strong>preload 预加载</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;link rel=&quot;preload&quot; href=&quot;/path/style.css&quot; as=&quot;style&quot;&gt;\`
\`&lt;link rel=&quot;preload&quot; href=&quot;/path/home.js&quot; as=&quot;script&quot;&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>preload 预加载是告诉浏览器页面必定需要的资源，浏览器会优先加载这些资源；使用 link 标签创建（vue 项目打包后，会将首页所用到的资源都加上 preload）</p><p>注意：preload 只是预加载资源，但不会执行，还需要引入具体的文件后才会执行 <code>&lt;script src=&#39;/path/home.js&#39;&gt;</code></p><p><strong>DNS 预解析</strong></p><p><code>DNS Prefetch</code> 是一种 DNS 预解析技术，当你浏览网页时，浏览器会在加载网页时，对网页中的域名进行解析缓存</p><p>这样在你单击当前网页中的连接时就无需进行<code>DNS</code> 的解析，减少用户等待时间，提高用户体验</p><p>使用<code>dns-prefetch</code>，如<code>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//img1.taobao.com&quot;&gt;</code></p><p>很多大型的网站，都会用<code>N</code> 个<code>CDN</code> 域名来做图片、静态文件等资源访问。解析单个域名同样的地点加上高并发难免有点堵塞，通过多个 CDN 域名来分担高并发下的堵塞</p><h4 id="_4、首屏不必要资源延迟加载" tabindex="-1"><a class="header-anchor" href="#_4、首屏不必要资源延迟加载" aria-hidden="true">#</a> 4、首屏不必要资源延迟加载</h4><p><strong>方式一： defer 或 async</strong></p><p>使用 script 标签的<code>defer或async</code>属性，这两种方式都是异步加载 js，不会阻塞 DOM 的渲染</p><p>async 是无顺序的加载，而 defer 是有顺序的加载</p><p>1）使用 defer 可以用来控制 js 文件的加载顺序</p><p>比如 jq 和 Bootstrap，因为 Bootstrap 中的 js 插件依赖于 jqery，所以必须先引入 jQuery，再引入 Bootstrap js 文件</p><p>2）如果你的脚本并不关心页面中的 DOM 元素（文档是否解析完毕），并且也不会产生其他脚本需要的数据，可以使用 async，如添加统计、埋点等资源</p><p><strong>方式二：依赖动态引入</strong></p><p>项目依赖的资源，推荐在各自的页面中动态引入，不要全部都放到 index.html 中</p><p>比如<code>echart.js</code>，只有 A 页面使用，可以在 A 页面的钩子函数中动态加载，在<code>onload事件</code>中进行 echart 初始化</p><p><strong>资源动态加载的代码示例</strong></p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>// url 要加载的资源
// isMustLoad 是否强制加载
<span class="token key attr-name">cont asyncLoadJs</span> <span class="token punctuation">=</span> <span class="token value attr-value">(url, isMustLoad = false) =&gt; {</span>
  <span class="token key attr-name">return new Promise((resolve, reject)</span> <span class="token punctuation">=</span><span class="token value attr-value">&gt; {</span>
    if (!isMustLoad) {
      <span class="token key attr-name">let srcArr</span> <span class="token punctuation">=</span> <span class="token value attr-value">document.getElementsByTagName(&quot;script&quot;);</span>
      <span class="token key attr-name">let hasLoaded</span> <span class="token punctuation">=</span> <span class="token value attr-value">false;</span>
      <span class="token key attr-name">let aTemp</span> <span class="token punctuation">=</span> <span class="token value attr-value">[];</span>
      <span class="token key attr-name">for (let i</span> <span class="token punctuation">=</span> <span class="token value attr-value">0; i &lt; srcArr.length; i++) {</span>
        // 判断当前js是否加载上
        if (srcArr[i].src) {
          aTemp.push(srcArr[i].src);
        }
      }
      <span class="token key attr-name">hasLoaded</span> <span class="token punctuation">=</span> <span class="token value attr-value">aTemp.indexOf(url) &gt; -1;</span>
      if (hasLoaded) {
        resolve();
        return;
      }
    }

    <span class="token key attr-name">let script</span> <span class="token punctuation">=</span> <span class="token value attr-value">document.createElement(&quot;script&quot;);</span>
    <span class="token key attr-name">script.type</span> <span class="token punctuation">=</span> <span class="token value attr-value">&quot;text/javascript&quot;;</span>
    <span class="token key attr-name">script.src</span> <span class="token punctuation">=</span> <span class="token value attr-value">url;</span>
    document.body.appendChild(script);
    // 资源加载成功的回调
    <span class="token key attr-name">script.onload</span> <span class="token punctuation">=</span> <span class="token value attr-value">() =&gt; {</span>
      resolve();
    };
    <span class="token key attr-name">script.onerror</span> <span class="token punctuation">=</span> <span class="token value attr-value">() =&gt; {</span>
      // reject();
    };
  });
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>方式三：import()</strong></p><p>使用<code>import() 动态加载路由和组件</code>，对资源进行拆分，只有使用的时候才进行动态加载</p><div class="language-dart line-numbers-mode" data-ext="dart"><pre class="language-dart"><code><span class="token comment">// 路由懒加载</span>
<span class="token keyword">const</span> <span class="token class-name">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;home&quot; */</span> <span class="token string-literal"><span class="token string">&#39;../views/home/index.vue&#39;</span></span><span class="token punctuation">)</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&#39;/&#39;</span></span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&#39;home&#39;</span></span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> <span class="token class-name">Home</span><span class="token punctuation">}</span> <span class="token punctuation">]</span>

<span class="token comment">// 组件懒加载</span>
<span class="token comment">// 在visible属性为true时，动态去加载demoComponent组件</span>
<span class="token operator">&lt;</span>demoComponent v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string-literal"><span class="token string">&quot;visible == true&quot;</span></span> <span class="token operator">/</span><span class="token operator">&gt;</span>

components<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    demoComponent<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;demoComponent&quot; */</span> <span class="token string-literal"><span class="token string">&#39;./demoComponent.vue&#39;</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5、合理利用缓存" tabindex="-1"><a class="header-anchor" href="#_5、合理利用缓存" aria-hidden="true">#</a> 5、合理利用缓存</h4><p>html 资源设置协商缓存，其他 js、css、图片等资源设置强缓存</p><p>当用户再次打开页面时，html 先和服务器校验，如果该资源未变化，服务器返回 304，直接使用缓存的文件；若返回 200，则返回最新的 html 资源</p><h4 id="_6、网络方面的优化" tabindex="-1"><a class="header-anchor" href="#_6、网络方面的优化" aria-hidden="true">#</a> 6、网络方面的优化</h4><p>1）开启服务器 Gzip 压缩，减少请求内容的体积，对文本类能压缩 60%以上</p><p>2）使用 HTTP2，接口解析速度快、多路复用、首部压缩等</p><p>3）减少 HTTP 请求，使用 url-loader，limit 限制图片大小，小图片转 base64</p><h4 id="_7、代码层面的优化" tabindex="-1"><a class="header-anchor" href="#_7、代码层面的优化" aria-hidden="true">#</a> 7、代码层面的优化</h4><p>1）前端长列表渲染优化，分页 + 虚拟列表，长列表渲染的性能效率与用户体验成正比</p><p>2）图片的懒加载、<code>图片的动态裁剪</code></p><p>特点是手机端项目，图片几乎不需要原图，使用七牛或阿里云的动态裁剪功能，可以将原本<code>几M</code>的大小裁剪成<code>几k</code></p><p>3）动画的优化，动画可以使用绝对定位，让其脱离文档流，修改动画不造成主界面的影响</p><p>使用 GPU 硬件加速包括：<code>transform 不为none、opacity、filter、will-change</code></p><p>4）函数的节流和防抖，减少接口的请求次数</p><p>5）使用骨架屏优化用户等待体验，可以根据不同路由配置不同的骨架</p><p>vue 项目推荐使用<code>vue-skeleton-webpack-plugin</code>，骨架屏原理将<code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt; </code>中的内容替换掉</p><p>6）大数据的渲染，如果数据不会变化，vue 项目可以使用<code>Object.freeze()</code></p><p>Object.freeze()方法可以冻结一个对象，Vue 正常情况下，会将 data 中定义的是对象变成响应式，但如果判断对象的自身属性不可修改，就直接返回改对象，省去了递归遍历对象的时间与内存消耗</p><p>7）定时器和绑定的事件，在页面销毁时卸载</p><h4 id="_8、webpack-优化" tabindex="-1"><a class="header-anchor" href="#_8、webpack-优化" aria-hidden="true">#</a> 8、webpack 优化</h4><p>提升构建速度或优化代码体积，推荐以下两篇文章</p>`,52),kn={href:"https://juejin.cn/post/6844903924806189070",target:"_blank",rel:"noopener noreferrer"},vn={href:"https://juejin.cn/post/6844904093463347208",target:"_blank",rel:"noopener noreferrer"},mn=e(`<h3 id="性能分析总结" tabindex="-1"><a class="header-anchor" href="#性能分析总结" aria-hidden="true">#</a> 性能分析总结</h3><p>1）先用 Lighthouse 得到当前页面的性能得分，了解页面的整体情况，重点关注 Opportunities 优化建议和 Diagnostics 诊断问题列表</p><p>2）通过 Performance 工具了解页面加载的整个过程，分析到底是资源加载慢、dom 渲染慢、还是 js 执行慢，找到具体的性能瓶颈在哪里，重点关注长任务（long task）</p><p>3）利用 Memory 工具，了解页面整体的内存使用情况，通过 JS 堆动态分配时间线，找到内存最高的时刻。结合具体的代码，去解决或优化内存变大的问题</p><h3 id="前端监控" tabindex="-1"><a class="header-anchor" href="#前端监控" aria-hidden="true">#</a> 前端监控</h3><p>没有监控的项目，就是在<code>“裸奔”</code></p><p>需要通过监控才能真正了解项目的整体情况，各项指标要通过大量的数据采集、数据分析，变得更有意义</p><p>监控的好处：事前预警和事后分析</p><p><strong>事前预警</strong>：设置一个阈值，当监控的数据达到阈值时，通过各种渠道通知管理员和开发，提前避免可能会造成的宕机或崩溃</p><p><strong>事后分析</strong>：通过监控日志文件，分析故障原因和故障发生点。从而做出修改，防止这种情况再次发生</p><p>我们可以使用市面上现有的工具，也可以自建 sentry 监控，关键在于通过这些数据，能看到这些<code>冰冷数据背后的故事</code></p><h2 id="组件库" tabindex="-1"><a class="header-anchor" href="#组件库" aria-hidden="true">#</a> 组件库</h2><p>组件库是开发项目时必备的工具，因为现在各个大厂提供的组件库都太好用了，反而让大家轻视了组件库的重要性</p><p>现在开发一个新项目，如果要求不能用现成的组件库，我估计要瞬间懵逼，无从下手了，不知不觉中，我已经患上严重的<code>组件库依赖症</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>如果让我只能说出一种，快速提升编程技能的方法，我一定会推荐去看看组件库源码
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>因为组件库源码中，都是最经典的案例，是集大成的杰作</strong></p><p>相比于前端框架源码的晦涩，组件库源码更容易上手，里边很多经典场景的写法，我们都可以借鉴，然后运用到实际的项目中</p><p>比如最常用的弹框组件，里边的<code>流程控制、层级控制、组件间事件派发与广播、递归查找组件</code>等设计，相当惊艳，真没想到一个小小的弹框组件，也是内有乾坤</p>`,18),bn={href:"https://juejin.cn/column/7095181360632971300",target:"_blank",rel:"noopener noreferrer"},gn=n("h2",{id:"总结",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#总结","aria-hidden":"true"},"#"),s(" 总结")],-1),hn=n("p",null,[s("工程化，是一个非常容易"),n("code",null,"出彩"),s("的方向，是展现一个侠者内功是否深厚的窗口")],-1),fn=n("p",null,[s("文中大部分知识点，只是"),n("code",null,"入门级教程"),s("，也是我以后需要持续努力的方向")],-1),yn={href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxy-sea%2Fblog%2Ftree%2Fdev%2F%E5%B7%A5%E7%A8%8B%E5%8C%96%E7%AF%87",target:"_blank",rel:"noopener noreferrer"};function qn(wn,jn){const a=i("ExternalLinkIcon");return o(),c("div",null,[n("p",null,[s("引用于"),n("a",u,[s("掘金-海阔_天空"),t(a)])]),r,n("p",null,[n("a",d,[s("mini-webpack 的 github 源码地址"),t(a)])]),k,n("p",null,[n("a",v,[s("轻松理解 webpack 热更新原理"),t(a)]),n("a",m,[s("深入浅出 Webpack"),t(a)]),n("a",b,[s("带你深度解锁 Webpack 系列(基础篇)"),t(a)])]),g,n("p",null,[n("a",h,[s("揭秘 webpack-plugin"),t(a)])]),f,n("p",null,[n("a",y,[s("揭秘 webpack-loader"),t(a)])]),q,n("p",null,[n("a",w,[s("精读《Webpack5 新特性 - 模块联邦》"),t(a)]),n("a",j,[s("Webpack 5 模块联邦引发微前端的革命？"),t(a)]),n("a",x,[s("Webpack 5 升级内容（二：模块联邦）"),t(a)])]),_,n("p",null,[n("a",F,[s("推荐珠峰的从零手写 vite 视频"),t(a)])]),S,n("p",null,[n("a",P,[s("尤雨溪几年前开发的“玩具 vite”"),t(a)]),n("a",T,[s("Vite 原理浅析"),t(a)])]),A,n("p",null,[s("AST 抽象语法树的结构，可以通过"),n("a",C,[s("AST 网站"),t(a)]),s("在线输入代码查看")]),n("p",null,[n("a",L,[s("AST 抽象语法树——最基础的 javascript 重点知识，99%的人根本不了解"),t(a)])]),D,n("p",null,[n("a",E,[s("Babel 入门教程"),t(a)]),n("a",M,[s("Babel 中文文档"),t(a)]),n("a",z,[s("不容错过的 Babel 知识"),t(a)]),n("a",I,[s("快速写一个 babel 插件"),t(a)])]),O,n("p",null,[s("以"),B,s("为例，下载"),n("a",H,[s("elementUI 源码"),t(a)])]),N,n("p",null,[n("a",R,[s("elementUI 多套主题下 按需引入和全局引入 的换肤方案"),t(a)])]),W,n("p",null,[n("a",V,[s("自定义脚手架 github 源码地址"),t(a)]),n("a",J,[s("my-2022-cli"),t(a)])]),G,n("p",null,[s("这里以"),n("a",U,[s("juejin.cn"),t(a)]),s("网站为例， 打开 Chrome 浏览器控制台，选择"),$,s("选项，点击"),Y]),K,n("p",null,[n("a",Q,[s("性能测评工具 lighthouse 的使用"),t(a)])]),X,n("p",null,[n("a",Z,[s("web-vitals"),t(a)]),s("是 Google 给出的定义是 一个"),nn]),sn,n("p",null,[n("a",an,[s("全新 Chrome Devtool Performance 使用指南"),t(a)]),n("a",tn,[s("手把手带你入门前端工程化——超详细教程"),t(a)]),n("a",en,[s("Chrome Devtool — Performance"),t(a)])]),pn,n("p",null,[n("a",on,[s("chrome 内存泄露（一）、内存泄漏分析工具"),t(a)]),n("a",cn,[s("chrome 内存泄露（二）、内存泄漏实例"),t(a)]),n("a",ln,[s("JavaScript 进阶-常见内存泄露及如何避免"),t(a)])]),un,n("p",null,[s("可以使用"),n("a",rn,[s("webpack-bundle-analyzer"),t(a)]),s("插件(vue 项目可以使用--report)生成资源分析图")]),dn,n("p",null,[n("a",kn,[s("Webpack 优化——将你的构建效率提速翻倍"),t(a)]),n("a",vn,[s("带你深度解锁 Webpack 系列(优化篇)"),t(a)])]),mn,n("p",null,[s("推荐一下我正在写的"),n("a",bn,[s("ElementUI 源码-打造自己的组件库"),t(a)]),s("文章，经典的东西永远是经典")]),gn,hn,fn,n("p",null,[n("a",yn,[s("工程化篇 github 源码仓库"),t(a)])])])}const Fn=p(l,[["render",qn],["__file","index.html.vue"]]);export{Fn as default};
